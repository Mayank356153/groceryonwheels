"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[3366],{14840:(e,t,a)=>{a.d(t,{A:()=>o});var r=a(65043),s=a(21197),i=a(59255),n=a(70579);function o(){const[e,t]=(0,r.useState)(!1);return(0,n.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,n.jsx)(s.A,{isSidebarOpen:e,setSidebarOpen:t}),(0,n.jsxs)("div",{className:"flex flex-grow mt-20",children:[(0,n.jsx)("div",{children:(0,n.jsx)(i.A,{isSidebarOpen:e})}),(0,n.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex flex-col items-center",children:[(0,n.jsx)("div",{className:"w-12 h-12 border-4 rounded-full border-cyan-500 border-t-transparent animate-spin"}),(0,n.jsx)("p",{className:"mt-3 text-lg font-semibold text-gray-700",children:"Loading..."})]})})]})]})}},23366:(e,t,a)=>{a.r(t),a.d(t,{default:()=>f});var r=a(65043),s=a(66727),i=a(86213),n=a(21197),o=a(59255),l=a(14840),d=a(49804),c=a(60184),m=a(70579);const u=new Audio("/sounds/beep-new.mp3"),h=new Audio("/sounds/beep-repeat.mp3");function x(e){try{e.pause(),e.currentTime=0,e.play()}catch{}}const f=function(){const e=(0,s.Zp)(),[t]=(0,s.ok)(),a=t.get("id"),[f,v]=(0,r.useState)(!0),[p,b]=(0,r.useState)(!1);(0,r.useEffect)((()=>{window.innerWidth<768&&v(!1)}),[]);const[y,g]=(0,r.useState)([]),[N,j]=(0,r.useState)([]),[w,k]=(0,r.useState)([]),[S,W]=(0,r.useState)(""),[C,I]=(0,r.useState)([]),[A,_]=(0,r.useState)({transferDate:(new Date).toLocaleDateString("en-CA"),fromWarehouse:"",toWarehouse:"",details:"",note:""}),$=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A.fromWarehouse;try{b(!0);const t=localStorage.getItem("token"),a=e?{warehouse:e}:{},{data:r}=await i.A.get("/api/items",{headers:{Authorization:`Bearer ${t}`},params:a}),s=(r.data||[]).map((e=>{var t;const a=Boolean(e.parentItemId);return{...e,parentId:a?e.parentItemId:e._id,variantId:a?e._id:null,displayName:a?`${e.itemName} / ${e.variantName||"Variant"}`:e.itemName,itemCode:e.itemCode||"",barcode:(null===(t=e.barcodes)||void 0===t?void 0:t[0])||"",barcodes:e.barcodes||[],isVariant:a,currentStock:e.currentStock||0,warehouse:e.warehouse}})).filter((e=>e.currentStock>0));return j(s),k(s),s}catch(t){console.error("items:",t.message),j([]),k([])}finally{b(!1)}};(0,r.useEffect)((()=>{(async()=>{try{b(!0);const t=localStorage.getItem("token"),{data:r}=await i.A.get("/api/warehouses",{headers:{Authorization:`Bearer ${t}`}}),s=r.data||[];if(g(s),!a&&s.length){var e;const t=s.find((e=>e.isRestricted&&"Active"===e.status)),a=t?t._id:(null===(e=s.find((e=>"Active"===e.status)))||void 0===e?void 0:e._id)||"";_((e=>({...e,fromWarehouse:a})))}}catch(t){console.error("warehouses:",t.message)}finally{b(!1)}})()}),[]),(0,r.useEffect)((()=>{A.fromWarehouse?$(A.fromWarehouse):(j([]),k([]))}),[A.fromWarehouse]),(0,r.useEffect)((()=>{a&&(async e=>{try{var t,a,r,s;b(!0);const n=localStorage.getItem("token"),{data:o}=await i.A.get(`/api/stock-transfers/${e}`,{headers:{Authorization:`Bearer ${n}`}}),l=o.data;_({transferDate:(null===(t=l.transferDate)||void 0===t?void 0:t.split("T")[0])||"",fromWarehouse:(null===(a=l.fromWarehouse)||void 0===a?void 0:a._id)||"",toWarehouse:(null===(r=l.toWarehouse)||void 0===r?void 0:r._id)||"",details:l.details||"",note:l.note||""});let d=[];null!==(s=l.fromWarehouse)&&void 0!==s&&s._id&&(d=await $(l.fromWarehouse._id));const c=(l.items||[]).map((e=>{var t,a;const r=d.find((t=>{var a;return t._id===((null===(a=e.item)||void 0===a?void 0:a._id)||e.item)}))||{},s=e.quantity||1,i=r.currentStock||0;return{itemId:(null===(t=e.item)||void 0===t?void 0:t._id)||e.item,itemName:r.displayName||(null===(a=e.item)||void 0===a?void 0:a.itemName)||"Unknown Item",quantity:s,origQty:s,maxQty:i+s,isVariant:r.isVariant||!1,variantName:r.variantName||""}}));I(c)}catch(n){console.error("load transfer:",n.message),alert("Error loading stock transfer")}finally{b(!1)}})(a)}),[a]),(0,r.useEffect)((()=>{if(A.fromWarehouse){const e=N.filter((e=>{var t;return(null===(t=e.warehouse)||void 0===t?void 0:t._id)===A.fromWarehouse}));k(e),a||I([])}else k([]),a||I([])}),[A.fromWarehouse,N,a]);const q=S?w.filter((e=>{const t=S.toLowerCase();return e.displayName.toLowerCase().includes(t)||e.itemCode.toLowerCase().includes(t)||e.barcode&&e.barcode.toLowerCase().includes(t)})):[],D=e=>{if(!e)return;if((e.currentStock||0)<=0)return void alert(`${e.displayName} has only ${e.currentStock||0} in stock.\nYou must leave at least one unit behind.`);const t=C.find((t=>t.itemId===e._id));if(t){if(t.quantity>=t.maxQty)return void alert(`Max transferable qty is ${t.maxQty}.`);I(C.map((t=>t.itemId===e._id?{...t,quantity:t.quantity+1}:t))),x(h)}else I([...C,{itemId:e._id,itemName:e.displayName,quantity:1,maxQty:e.currentStock,isVariant:e.isVariant,variantName:e.variantName}]),x(u);W("")};return p?(0,m.jsx)(l.A,{}):(0,m.jsxs)("div",{className:"flex flex-col h-screen bg-gray-100",children:[(0,m.jsx)(n.A,{isSidebarOpen:f,setSidebarOpen:v}),(0,m.jsxs)("div",{className:"flex flex-grow",children:[(0,m.jsx)(o.A,{isSidebarOpen:f}),(0,m.jsxs)("div",{className:"flex-grow p-4",children:[(0,m.jsxs)("header",{className:"flex flex-col items-center justify-between p-4 mb-2 bg-white rounded shadow md:flex-row",children:[(0,m.jsxs)("div",{className:"flex items-baseline gap-2",children:[(0,m.jsx)("h1",{className:"text-xl font-semibold",children:a?"Edit Stock Transfer":"Add Stock Transfer"}),(0,m.jsx)("span",{className:"text-sm text-gray-600",children:a?"Update existing transfer":"Create new transfer"})]}),(0,m.jsxs)("nav",{className:"flex items-center text-sm text-gray-500",children:[(0,m.jsxs)("a",{href:"/dashboard",className:"flex items-center hover:text-cyan-600",children:[(0,m.jsx)(c.$BV,{className:"mr-2"})," Home"]}),(0,m.jsx)(d.XWt,{className:"mx-2"}),(0,m.jsx)("a",{href:"/transfer-list",className:"hover:text-cyan-600",children:"Stock Transfer List"})]})]}),(0,m.jsxs)("form",{onSubmit:async t=>{if(t.preventDefault(),!A.transferDate||!A.fromWarehouse||!A.toWarehouse)return alert("Fill date, From & To warehouse.");if(A.fromWarehouse===A.toWarehouse)return alert("Cannot transfer to the same warehouse.");if(0===C.length)return alert("Add at least one item.");for(const e of C){var r;const t=(e.origQty||0)+((null===(r=N.find((t=>t._id===e.itemId)))||void 0===r?void 0:r.currentStock)||0);if(e.quantity>t)return alert(`Cannot transfer ${e.quantity} of \u201c${e.itemName}\u201d. Only ${t} available to transfer right now.`)}b(!0);try{const t={...A,items:C.map((e=>({item:e.itemId,quantity:e.quantity})))},r=localStorage.getItem("token");a?(await i.A.put(`/api/stock-transfers/${a}`,t,{headers:{Authorization:`Bearer ${r}`}}),alert("Stock transfer updated!")):(await i.A.post("/api/stock-transfers",t,{headers:{Authorization:`Bearer ${r}`}}),alert("Stock transfer created!")),e("/transfer-list")}catch(o){var s,n;console.error("submit:",o),alert((null===(s=o.response)||void 0===s||null===(n=s.data)||void 0===n?void 0:n.message)||"Submit failed.")}finally{b(!1)}},className:"p-4 bg-white border-t-4 rounded shadow border-cyan-500",children:[(0,m.jsxs)("div",{className:"grid gap-4 mb-4 md:grid-cols-3",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"Transfer Date"}),(0,m.jsx)("input",{type:"date",value:A.transferDate,onChange:e=>_({...A,transferDate:e.target.value}),className:"w-full px-3 py-2 border rounded",required:!0})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"From Warehouse"}),(0,m.jsxs)("select",{value:A.fromWarehouse,onChange:e=>_({...A,fromWarehouse:e.target.value}),className:"w-full px-3 py-2 border rounded",required:!0,children:[(0,m.jsx)("option",{value:"",children:"Select Warehouse"}),y.map((e=>(0,m.jsx)("option",{value:e._id,children:e.warehouseName},e._id)))]})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"To Warehouse"}),(0,m.jsxs)("select",{value:A.toWarehouse,onChange:e=>_({...A,toWarehouse:e.target.value}),className:"w-full px-3 py-2 border rounded",required:!0,children:[(0,m.jsx)("option",{value:"",children:"Select Warehouse"}),y.map((e=>(0,m.jsx)("option",{value:e._id,children:e.warehouseName},e._id)))]})]})]}),(0,m.jsxs)("div",{className:"grid gap-4 mb-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"Details"}),(0,m.jsx)("input",{type:"text",value:A.details,onChange:e=>_({...A,details:e.target.value}),className:"w-full px-3 py-2 border rounded"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"Note"}),(0,m.jsx)("input",{type:"text",value:A.note,onChange:e=>_({...A,note:e.target.value}),className:"w-full px-3 py-2 border rounded"})]})]}),(0,m.jsxs)("div",{className:"relative mb-4",children:[(0,m.jsx)("label",{className:"block mb-1 font-semibold",children:"Search Item"}),(0,m.jsx)("input",{type:"text",placeholder:"Name / Code / Barcode",value:S,onChange:e=>{const t=e.target.value.trim();W(t);const a=N.find((e=>{var a;return(null===(a=e.barcodes)||void 0===a?void 0:a.includes(t))||e.itemCode===t}));a&&D(a)},onKeyDown:e=>{"Enter"===e.key&&e.preventDefault()},className:"w-full px-4 py-2 border rounded",disabled:!A.fromWarehouse}),S&&q.length>0&&(0,m.jsx)("ul",{className:"absolute z-50 w-full max-h-60 overflow-y-auto bg-white border rounded shadow mt-1",children:q.map((e=>(0,m.jsxs)("li",{className:"p-2 cursor-pointer hover:bg-gray-100",onClick:()=>D(e),children:[(0,m.jsx)("strong",{children:e.itemCode})," \u2013 ",e.displayName,e.isVariant?` (${e.variantName})`:"",e.barcode&&(0,m.jsxs)("span",{className:"text-gray-500",children:[" \u2013 ",e.barcode]})]},e._id)))})]}),(0,m.jsxs)("div",{className:"p-4 mb-4 bg-white rounded shadow overflow-x-auto",children:[(0,m.jsxs)("div",{className:"flex px-2 py-2 text-sm font-semibold text-white bg-cyan-600",children:[(0,m.jsx)("div",{className:"w-2/3",children:"Item Name"}),(0,m.jsx)("div",{className:"w-1/3 text-center",children:"Qty"}),(0,m.jsx)("div",{className:"w-1/3 text-center",children:"Action"})]}),0===C.length&&(0,m.jsx)("div",{className:"p-4 text-center text-gray-500",children:"No items added."}),C.map((e=>(0,m.jsxs)("div",{className:"flex items-center px-2 py-2 border-t",children:[(0,m.jsx)("div",{className:"w-2/3",children:e.itemName}),(0,m.jsxs)("div",{className:"w-1/3 text-center",children:[(0,m.jsx)("input",{type:"number",min:"1",max:e.maxQty,value:e.quantity,onChange:t=>((e,t)=>{I(C.map((a=>{if(a.itemId!==e)return a;const r=parseInt(t,10)||1,s=a.maxQty;return r>s?(alert(`Stock limit exceeded. Max transferable is ${s}.`),{...a,quantity:s}):{...a,quantity:r}})))})(e.itemId,t.target.value),className:"w-16 text-center border rounded"}),(0,m.jsxs)("div",{className:"text-xs text-gray-400",children:["max ",e.maxQty]})]}),(0,m.jsx)("div",{className:"w-1/3 text-center",children:(0,m.jsx)("button",{type:"button",onClick:()=>(e=>I(C.filter((t=>t.itemId!==e))))(e.itemId),className:"px-2 py-1 text-white bg-red-500 rounded",children:"Remove"})})]},e.itemId)))]}),(0,m.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,m.jsx)("button",{type:"submit",className:"px-6 py-2 text-white rounded shadow bg-cyan-500 hover:bg-cyan-600",children:a?"Update":"Save"}),(0,m.jsx)("button",{type:"button",onClick:()=>e("/transfer-list"),className:"px-6 py-2 text-white bg-gray-400 rounded shadow hover:bg-gray-500",children:"Cancel"})]})]})]})]})]})}}}]);
//# sourceMappingURL=3366.2a48b768.chunk.js.map