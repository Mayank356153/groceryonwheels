"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[4477],{4477:(e,t,a)=>{a.r(t),a.d(t,{default:()=>j});var n=a(65043),s=a(60184),r=a(31782),o=a(30064),l=a.n(o),i=a(6720),d=a(96130),c=a(86213),u=a(66727),m=(a(37762),a(64857),a(70579));const p=e=>{let{onClose:t,onSubmit:a,paymentMode:r,paymentTypes:o=[],accounts:l=[],terminals:i=[],initialAdvance:d=0,initialAccount:c="",initialSummary:u={totalItems:0,totalPrice:0,discount:0,couponDiscount:0,totalPayable:0,totalPaying:0,balance:0,changeReturn:0},selectedWarehouse:p}=e;const h=e=>{var t;return null===(t=o.find((t=>{var a;return(null===(a=t.paymentTypeName)||void 0===a?void 0:a.toLowerCase())===e.toLowerCase()})))||void 0===t?void 0:t._id},[x,g]=(0,n.useState)(""),[v,b]=(0,n.useState)(d),[y,f]=(0,n.useState)(!1),[N,j]=(0,n.useState)(u),[w,C]=(0,n.useState)((()=>{return"cash"===r?[{paymentType:h("Cash")||"",amount:u.totalPayable,note:"",terminal:null,account:c||""}]:"bank"===r?[{paymentType:h("Bank")||"",amount:u.totalPayable,note:"",terminal:(null===(e=i.find((e=>e.warehouse===p)))||void 0===e?void 0:e._id)||"",account:null}]:[{paymentType:"",amount:0,note:"",terminal:null,account:null}];var e}));(0,n.useEffect)((()=>{const e=w.reduce(((e,t)=>e+Number(t.amount||0)),0),t=x?u.couponDiscount:0,a=y?Number(v):0,n=u.totalPrice-u.discount-a,s=n-e,r=e>n?e-n:0;j({totalItems:u.totalItems,totalPrice:u.totalPrice,discount:u.discount,couponDiscount:t,totalPayable:n,totalPaying:e,balance:s>0?s:0,changeReturn:r})}),[w,x,y,v,u.totalPrice,u.discount,u.couponDiscount,u.totalItems]),(0,n.useEffect)((()=>{C((e=>e.map((e=>{if(e.paymentType===h("Bank")){var t;const a=i.filter((e=>e.warehouse===p)),n=a.find((t=>t._id===e.terminal))?e.terminal:(null===(t=a[0])||void 0===t?void 0:t._id)||"";return{...e,terminal:n}}return e}))))}),[p,i,o]);const S=(e,t,a)=>{C((n=>n.map(((n,s)=>{if(s!==e)return n;const r={...n,[t]:a};if("paymentType"===t){const e=a===h("Cash"),t=a===h("Bank");if(e)r.account=c,r.terminal=null;else if(t){var o;r.terminal=(null===(o=i.find((e=>e.warehouse===p)))||void 0===o?void 0:o._id)||"",r.account=null}else r.account=null,r.terminal=null}return r}))))};return(0,m.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:(0,m.jsxs)("div",{className:"relative w-full max-w-4xl p-4 bg-white rounded shadow-lg",children:[(0,m.jsx)("button",{className:"absolute text-gray-600 top-2 right-2 hover:text-gray-800",onClick:t,children:(0,m.jsx)(s.QCr,{size:18})}),(0,m.jsx)("h2",{className:"mb-4 text-xl font-bold capitalize",children:"multiple"===r?"Multiple Payment":"cash"===r?"Cash Payment":"Bank Payment"}),(0,m.jsxs)("div",{className:"flex flex-col gap-4 md:flex-row",children:[(0,m.jsxs)("div",{className:"flex-1 p-4 border rounded bg-gray-50",children:[(0,m.jsxs)("div",{className:"mb-4",children:[(0,m.jsx)("label",{className:"block mb-1 text-sm font-semibold",children:"Discount Coupon Code"}),(0,m.jsx)("input",{type:"text",className:"w-full p-2 border rounded",placeholder:"Enter Coupon Code",value:x,onChange:e=>g(e.target.value)})]}),(0,m.jsxs)("div",{className:"mb-4",children:[(0,m.jsx)("label",{className:"block mb-1 text-sm font-semibold",children:"Adjust Advance Payment"}),(0,m.jsxs)("div",{className:"flex items-center gap-2",children:[(0,m.jsx)("input",{type:"checkbox",checked:y,onChange:e=>f(e.target.checked)}),(0,m.jsx)("input",{type:"number",className:"w-full p-2 border rounded",placeholder:"Enter Advance Amount",value:v,onChange:e=>b(Number(e.target.value)),disabled:!y,min:"0"})]})]}),(0,m.jsxs)("div",{className:"mb-4",children:[(0,m.jsx)("label",{className:"block mb-2 text-sm font-semibold",children:"Payment Details"}),w.map(((e,t)=>(0,m.jsxs)("div",{className:"p-2 mb-2 border rounded",children:[(0,m.jsx)("label",{className:"block mb-1 text-xs font-medium",children:"Payment Type"}),(0,m.jsxs)("select",{className:"w-full p-2 mb-2 border rounded",value:e.paymentType,onChange:e=>S(t,"paymentType",e.target.value),children:[(0,m.jsx)("option",{value:"",children:"-- Select Payment Type --"}),o.map((e=>(0,m.jsx)("option",{value:e._id,children:e.paymentTypeName},e._id)))]}),e.paymentType===h("Cash")&&(0,m.jsxs)("div",{className:"mb-2",children:[(0,m.jsx)("label",{className:"block mb-1 text-xs font-medium",children:"Select Account"}),(0,m.jsxs)("select",{className:"w-full p-2 border rounded",value:e.account||"",onChange:e=>S(t,"account",e.target.value),children:[(0,m.jsx)("option",{value:"",children:"-- Select an Account --"}),l.map((e=>(0,m.jsx)("option",{value:e._id,children:e.accountName},e._id)))]})]}),e.paymentType===h("Bank")&&(0,m.jsxs)("div",{className:"mb-2",children:[(0,m.jsx)("label",{className:"block mb-1 text-xs font-medium",children:"Terminal"}),(0,m.jsxs)("select",{className:"w-full p-2 border rounded",value:e.terminal||"",onChange:e=>S(t,"terminal",e.target.value),children:[(0,m.jsx)("option",{value:"",children:"-- Select Terminal --"}),i.filter((e=>e.warehouse===p)).map((e=>(0,m.jsx)("option",{value:e._id,children:e.tid},e._id)))]})]}),(0,m.jsx)("label",{className:"block mb-1 text-xs font-medium",children:"Amount"}),(0,m.jsx)("input",{type:"number",className:"w-full p-2 mb-2 border rounded",value:e.amount,onChange:e=>S(t,"amount",Number(e.target.value)),min:"0"}),(0,m.jsx)("label",{className:"block mb-1 text-xs font-medium",children:"Payment Note"}),(0,m.jsx)("input",{type:"text",className:"w-full p-2 border rounded",placeholder:"Enter Payment Note",value:e.note,onChange:e=>S(t,"note",e.target.value)})]},t))),"multiple"===r&&(0,m.jsx)("button",{onClick:()=>"multiple"===r&&C([...w,{paymentType:"",amount:0,note:"",terminal:null,account:null}]),className:"px-2 py-1 text-sm text-white bg-blue-600 rounded",children:"+ Add Payment Row"})]})]}),(0,m.jsxs)("div",{className:"flex-1 p-4 bg-white border rounded",children:[(0,m.jsx)("h3",{className:"mb-2 text-sm font-bold",children:"Summary"}),(0,m.jsx)("div",{className:"flex flex-col gap-1 text-sm",children:[["Total Items:",N.totalItems],["Total Price (\u20b9):",N.totalPrice],["Discount (\u20b9):",N.discount],["Coupon Discount (\u20b9):",N.couponDiscount],["Advance Used (\u20b9):",y?v:0],["Total Payable (\u20b9):",N.totalPayable],["Total Paying (\u20b9):",N.totalPaying],["Balance (\u20b9):",N.balance],["Change Return (\u20b9):",N.changeReturn]].map((e=>{let[t,a]=e;return(0,m.jsxs)("div",{className:"flex justify-between",children:[(0,m.jsx)("span",{children:t}),(0,m.jsx)("span",{children:Number(a).toFixed(2)})]},t)}))}),(0,m.jsxs)("div",{className:"flex justify-end mt-4",children:[(0,m.jsx)("button",{onClick:t,className:"px-3 py-1 mr-2 text-gray-700 bg-gray-300 rounded",children:"Close"}),(0,m.jsx)("button",{onClick:()=>{w.some((e=>!e.paymentType||Number(e.amount)<=0||e.paymentType===h("Bank")&&!e.terminal||e.paymentType===h("Cash")&&!e.account))?alert("Select a payment type, enter a positive amount, select a terminal for bank payments, and select an account for cash payments."):(a({paymentRows:w.map((e=>({paymentType:e.paymentType,amount:Number(e.amount),note:e.note,terminal:e.terminal||void 0,account:e.account||void 0}))),couponCode:x,adjustAdvancePayment:y,advance:Number(v),selectedAccount:void 0}),t())},className:"px-3 py-1 text-white bg-green-600 rounded",children:"Save & Print"})]})]})]})]})})};var h=a(14840),x=a(26873);const g=e=>t=>{var a;return{label:t[e],value:null!==(a=t._id)&&void 0!==a?a:t[e]}};function v(e){let{open:t,onClose:a,onCreated:s}=e;const r={customerName:"",email:"",mobile:"",phone:"",address:"",city:"",state:"",country:"",postcode:"",gstNumber:"",taxNumber:"",openingBalance:0,previousBalance:0,purchaseDue:0,purchaseReturnDue:0,status:"Active",type:"Online",shippingCity:"",shippingArea:"",shippingState:"",shippingPostcode:"",shippingLocationLink:"",shippingCountry:"",panNumber:"",priceLevel:0,priceLevelType:"",salesReturnDue:0,customerId:"",attachmentPath:"",customerImage:"",openingBalancePayments:[]},[o,l]=(0,n.useState)(r),[i,d]=(0,n.useState)([]),[u,p]=(0,n.useState)([]),[h,v]=(0,n.useState)(!1),[b,y]=(0,n.useState)("");if((0,n.useEffect)((()=>{if(!t)return;l(r),y("");const e={headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}};Promise.all([c.A.get("/api/countries",e),c.A.get("/api/states",e)]).then((e=>{let[t,a]=e;d((t.data.data||[]).filter((e=>"active"===e.status)).map(g("countryName"))),p((a.data.data||[]).filter((e=>"active"===e.status)).map(g("stateName")))})).catch((e=>y("Failed to load country/state lists")))}),[t]),(0,n.useEffect)((()=>{if(!t)return;const e=e=>"Escape"===e.key&&a();return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)}),[t,a]),!t)return null;const f=e=>l({...o,[e.target.name]:"number"===e.target.type?Number(e.target.value):e.target.value});return(0,m.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:a,children:(0,m.jsxs)("form",{onClick:e=>e.stopPropagation(),onSubmit:async e=>{e.preventDefault(),v(!0),y("");try{const{data:e}=await c.A.post("api/customer-data/create",o,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});null===s||void 0===s||s(e.data||e),a()}catch(r){var t,n;y((null===(t=r.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.message)||r.message||"Save failed")}finally{v(!1)}},className:"max-h-[95vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white p-6 shadow-lg",children:[(0,m.jsx)("h2",{className:"mb-4 text-xl font-semibold text-center",children:"Add Customer"}),(0,m.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm font-medium",children:"Customer Name *"}),(0,m.jsx)("input",{required:!0,name:"customerName",value:o.customerName,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Email"}),(0,m.jsx)("input",{type:"email",name:"email",value:o.email,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Mobile"}),(0,m.jsx)("input",{name:"mobile",value:o.mobile,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Phone"}),(0,m.jsx)("input",{name:"phone",value:o.phone,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4",children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Address"}),(0,m.jsx)("textarea",{name:"address",rows:"2",value:o.address,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"City"}),(0,m.jsx)("input",{name:"city",value:o.city,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Postcode"}),(0,m.jsx)("input",{name:"postcode",value:o.postcode,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Country"}),(0,m.jsx)(x.Ay,{options:i,value:i.find((e=>e.value===o.country))||null,onChange:e=>l({...o,country:(null===e||void 0===e?void 0:e.value)||""}),placeholder:"Select country"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"State"}),(0,m.jsx)(x.Ay,{options:u,value:u.find((e=>e.value===o.state))||null,onChange:e=>l({...o,state:(null===e||void 0===e?void 0:e.value)||""}),placeholder:"Select state"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"GST Number"}),(0,m.jsx)("input",{name:"gstNumber",value:o.gstNumber,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Tax Number"}),(0,m.jsx)("input",{name:"taxNumber",value:o.taxNumber,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Opening Balance"}),(0,m.jsx)("input",{type:"number",min:"0",name:"openingBalance",value:o.openingBalance,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Previous Balance"}),(0,m.jsx)("input",{type:"number",min:"0",name:"previousBalance",value:o.previousBalance,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Purchase Due"}),(0,m.jsx)("input",{type:"number",min:"0",name:"purchaseDue",value:o.purchaseDue,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Purchase Return Due"}),(0,m.jsx)("input",{type:"number",min:"0",name:"purchaseReturnDue",value:o.purchaseReturnDue,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Customer Type"}),(0,m.jsxs)("select",{name:"type",value:o.type,onChange:f,className:"w-full rounded border px-3 py-2",children:[(0,m.jsx)("option",{value:"Online",children:"Online"}),(0,m.jsx)("option",{value:"Offline",children:"Offline"})]})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Status"}),(0,m.jsxs)("select",{name:"status",value:o.status,onChange:f,className:"w-full rounded border px-3 py-2",children:[(0,m.jsx)("option",{value:"Active",children:"Active"}),(0,m.jsx)("option",{value:"Inactive",children:"Inactive"})]})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping City"}),(0,m.jsx)("input",{name:"shippingCity",value:o.shippingCity,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping Area"}),(0,m.jsx)("input",{name:"shippingArea",value:o.shippingArea,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping State"}),(0,m.jsx)(x.Ay,{options:u,value:u.find((e=>e.value===o.shippingState))||null,onChange:e=>l({...o,shippingState:(null===e||void 0===e?void 0:e.value)||""}),placeholder:"Select shipping state"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping Postcode"}),(0,m.jsx)("input",{name:"shippingPostcode",value:o.shippingPostcode,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping Country"}),(0,m.jsx)(x.Ay,{options:i,value:i.find((e=>e.value===o.shippingCountry))||null,onChange:e=>l({...o,shippingCountry:(null===e||void 0===e?void 0:e.value)||""}),placeholder:"Select shipping country"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Shipping Location Link"}),(0,m.jsx)("input",{name:"shippingLocationLink",value:o.shippingLocationLink,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"PAN Number"}),(0,m.jsx)("input",{name:"panNumber",value:o.panNumber,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Price Level"}),(0,m.jsx)("input",{type:"number",min:"0",name:"priceLevel",value:o.priceLevel,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),(0,m.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Price Level Type"}),(0,m.jsx)("input",{name:"priceLevelType",value:o.priceLevelType,onChange:f,className:"w-full rounded border px-3 py-2"})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("label",{className:"mb-1 block text-sm",children:"Sales Return Due"}),(0,m.jsx)("input",{type:"number",min:"0",name:"salesReturnDue",value:o.salesReturnDue,onChange:f,className:"w-full rounded border px-3 py-2"})]})]}),b&&(0,m.jsx)("p",{className:"mt-4 rounded border border-red-300 bg-red-100 px-3 py-2 text-sm text-red-700",children:b}),(0,m.jsxs)("div",{className:"mt-6 flex justify-end gap-3",children:[(0,m.jsx)("button",{type:"button",onClick:a,className:"rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300",children:"Cancel"}),(0,m.jsx)("button",{disabled:h,className:"rounded bg-emerald-600 px-6 py-2 text-white hover:bg-emerald-700 disabled:opacity-60",children:h?"Saving\u2026":"Save"})]})]})})}const b=new Audio("/sounds/beep-new.mp3"),y=new Audio("/sounds/remove.mp3");function f(){try{b.pause(),b.currentTime=0,b.play()}catch{}}function N(){try{y.pause(),y.currentTime=0,y.play()}catch{}}function j(){const e=(0,u.Zp)(),[t]=(0,u.ok)(),a=t.get("id"),o=t.get("bookingId"),x=t.get("customer"),g=t.get("customerModel")||"CustomerData",[b,y]=(0,n.useState)({name:"Guest",role:"Guest"}),[j,w]=(0,n.useState)(!1),[C,S]=(0,n.useState)(!1),[k,P]=(0,n.useState)(!1),[A,I]=(0,n.useState)([]),[_,$]=(0,n.useState)(""),[T,D]=(0,n.useState)([]),[E,q]=(0,n.useState)(""),[L,B]=(0,n.useState)(""),[R,O]=(0,n.useState)([]),[F,M]=(0,n.useState)(""),[z,H]=(0,n.useState)([]),[G,Q]=(0,n.useState)([]),[W,U]=(0,n.useState)([]),[Y,X]=(0,n.useState)([]),[V,K]=(0,n.useState)(""),[Z,J]=(0,n.useState)(!1),[ee,te]=(0,n.useState)([]),[ae,ne]=(0,n.useState)(0),[se,re]=(0,n.useState)(0),[oe,le]=(0,n.useState)(0),[ie,de]=(0,n.useState)(`SL/${(new Date).getFullYear()}/${String((new Date).getMonth()+1).padStart(2,"0")}/`),[ce,ue]=(0,n.useState)(0),[me,pe]=(0,n.useState)(0),[he,xe]=(0,n.useState)(""),[ge,ve]=(0,n.useState)(!1),[be,ye]=(0,n.useState)(0),[fe,Ne]=(0,n.useState)([]),[je,we]=(0,n.useState)(!1),[Ce,Se]=(0,n.useState)(""),[ke,Pe]=(0,n.useState)(!1),[Ae,Ie]=(0,n.useState)(""),[_e,$e]=(0,n.useState)(""),Te=(0,n.useRef)(null),De=(0,n.useRef)(null),[Ee,qe]=(0,n.useState)(""),[Le,Be]=(0,n.useState)(null),[Re,Oe]=(0,n.useState)(""),Fe=(0,n.useRef)(),[Me,ze]=(0,n.useState)(!1),[He,Ge]=(0,n.useState)([]),[Qe,We]=(0,n.useState)("CustomerData"),Ue=()=>({headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),Ye=e=>{var t;return null===(t=G.find((t=>{var a;return(null===(a=t.paymentTypeName)||void 0===a?void 0:a.toLowerCase())===e.toLowerCase()})))||void 0===t?void 0:t._id};async function Xe(e,t){var a,n;if(!e||!t)return 0;const{data:s}=await c.A.get(`/api/stock/${t}?warehouse=${e}`,Ue());return null!==(a=null!==(n=s.currentStock)&&void 0!==n?n:s.openingStock)&&void 0!==a?a:0}async function Ve(){try{const e=(new Date).getFullYear(),[t,a]=await Promise.all([c.A.get("api/sales",Ue()),c.A.get("api/pos",Ue())]),n=t.data.sales||t.data,s=a.data.data||a.data,r=[...n.map((e=>e.saleCode)),...s.map((e=>e.saleCode))].filter(Boolean);let o=0;r.forEach((t=>{const a=t.split("/");if(a[1]==e){const e=parseInt(a[2],10);e>o&&(o=e)}}));const l=String(o+1).padStart(7,"0");de(`SL/${e}/${l}`)}catch(e){console.error("Could not compute next code:",e);const t=(new Date).getFullYear();de(`SL/${t}/${String((new Date).getMonth()+1).padStart(2,"0")}/`)}}async function Ke(){try{const{data:e}=await c.A.get("api/pos",Ue());Ne((e.data||e).filter((e=>"OnHold"===e.status)))}catch(e){console.error("Fetch held invoices error:",e.message)}}async function Ze(e){try{const{data:t}=await c.A.get(`api/pos/${e}`,Ue());return console.log("Fetched POS order:",t),t.order||t}catch(t){return console.error("Fetch POS by ID error:",t.message),alert(`Failed to load POS order: ${t.message}`),null}}async function Je(){if(_)try{const{data:e}=await c.A.get("api/items",{headers:Ue().headers,params:{warehouse:_,inStock:!0}}),t=(e.data||[]).filter((e=>{var t;return e._id&&(null===(t=e.warehouse)||void 0===t?void 0:t._id)})).map((e=>{const t=Boolean(e.parentItemId);return{...e,parentId:t?e.parentItemId:e._id,variantId:t?e._id:null,itemName:t?`${e.itemName} / ${e.variantName||"Variant"}`:e.itemName,barcode:e.barcode||"",barcodes:e.barcodes||[],itemCode:e.itemCode||""}}));console.log("Flattened items:",t.map((e=>{var t;return{_id:e._id,parentId:e.parentId,variantId:e.variantId,itemName:e.itemName,itemCode:e.itemCode,barcode:e.barcode,barcodes:e.barcodes,isVariant:!!e.variantId,warehouseId:null===(t=e.warehouse)||void 0===t?void 0:t._id}}))),U(t)}catch(e){console.error("Fetch items error:",e.message)}else U([])}function et(e){var t,a,n;console.log("Hydrating POS order:",e);let s=e.paymentMode||"";if(!s)if("OnHold"===e.status)s="hold";else if("Completed"===e.status){var r,o;if((null===(r=e.payments)||void 0===r?void 0:r.length)>1)s="multiple";else if(1===(null===(o=e.payments)||void 0===o?void 0:o.length)){var l,i;const t=e.payments[0],a=G.find((e=>e._id===t.paymentType));s="cash"===(null===a||void 0===a||null===(l=a.paymentTypeName)||void 0===l?void 0:l.toLowerCase())?"cash":"bank"===(null===a||void 0===a||null===(i=a.paymentTypeName)||void 0===i?void 0:i.toLowerCase())||t.terminal?"bank":"multiple"}}const d=e.items.map((t=>{var a,n,s,r;const o=W.find((a=>{var n,s;return a.parentId===t.item._id&&(!t.variant||a._id===t.variant||a.variantId===t.variant)&&(null===(n=a.warehouse)||void 0===n?void 0:n._id)===(null===(s=e.warehouse)||void 0===s?void 0:s._id)}));var l;return o?{item:t.item._id,variant:t.variant||null,itemName:o.itemName,itemCode:o.itemCode||"",openingStock:o.openingStock||0,currentStock:null!=o.currentStock?o.currentStock:o.openingStock||0,salesPrice:t.price||o.salesPrice||0,quantity:t.quantity||1,origQty:t.quantity||1,discount:t.discount||0,tax:(null===(a=t.tax)||void 0===a?void 0:a._id)||(null===(n=o.tax)||void 0===n?void 0:n._id)||null,taxRate:(null===(s=t.tax)||void 0===s?void 0:s.taxPercentage)||(null===(r=o.tax)||void 0===r?void 0:r.taxPercentage)||0,unit:t.unit||o.unit||null,mrp:o.mrp||0,expiryDate:o.expiryDate||null,subtotal:t.subtotal||(t.price||o.salesPrice||0)*(t.quantity||1)-(t.discount||0)}:(console.warn("Invalid item in POS order:",{itemId:t.item._id,variantId:t.variant,itemName:t.item.itemName,warehouseId:null===(l=e.warehouse)||void 0===l?void 0:l._id}),null)})).filter((e=>null!==e));te(d),de(e.saleCode||""),ue(e.invoiceCount||0),pe(e.previousBalance||0),xe(e.couponCode||""),ve(e.advanceUsed>0),ye(e.advanceUsed||0);const c=null===(t=e.customer)||void 0===t?void 0:t._id;if(c&&T.find((e=>e._id===c)))q(c);else{console.warn("Invalid or missing customer ID:",c);const e=T.find((e=>"walk-in customer"===e.customerName.toLowerCase()));q((null===e||void 0===e?void 0:e._id)||"")}const u=null===(a=e.warehouse)||void 0===a?void 0:a._id;var m;u&&A.find((e=>e._id===u))?$(u):(console.warn("Invalid or missing warehouse ID:",u),$((null===(m=A[0])||void 0===m?void 0:m._id)||""));const p=null===(n=e.account)||void 0===n?void 0:n._id;if(p&&R.find((e=>e._id===p)))M(p);else{var h,x;console.warn("Invalid or missing account ID:",p);const e=A.find((e=>e._id===u));M((null===e||void 0===e||null===(h=e.cashAccount)||void 0===h?void 0:h._id)||(null===(x=R[0])||void 0===x?void 0:x._id)||"")}Se(e._id),$e(s)}(0,n.useEffect)((()=>{if(Fe.current&&Fe.current!==_){if(ee.length>0){if(!window.confirm("Changing the warehouse will clear the current cart. Continue?"))return void $(Fe.current)}te([]),K("")}Fe.current=_}),[_,ee.length]),(0,n.useEffect)((()=>{x&&q(x),o&&B(o)}),[x,o]),(0,n.useEffect)((()=>{g&&We(g)}),[g]),(0,n.useEffect)((()=>{!async function(){w(!0);try{const e="admin"===localStorage.getItem("role")?"auth/profile":"admiaddinguser/profile",{data:t}=await c.A.get(e,Ue());y(t),qe(t.storeName||"Grocery on Wheels"),Oe(t.defaultWarehouse||"")}catch{y({name:"Guest",role:"Guest"})}finally{w(!1)}}(),async function(){try{const{data:e}=await c.A.get("api/warehouses",Ue()),t=e.data||e.warehouses||[];Array.isArray(t)?I(t):I([])}catch(e){console.error("\u274c failed to load warehouses",e),I([])}try{const{data:e}=await c.A.get("api/customer-data/all",Ue()),t=e.data||e||[];if(Array.isArray(t)){if(D(t),!a&&!x&&t.length){const e=t.find((e=>"walk-in customer"===e.customerName.toLowerCase()));q((null===e||void 0===e?void 0:e._id)||t[0]._id)}}else D([])}catch(e){console.error("\u274c failed to load customers",e),D([])}try{const{data:e}=await c.A.get("api/accounts",Ue()),t=e.data||e||[];Array.isArray(t)?(O(t),!a&&t.length&&M(t[0]._id)):O([])}catch(e){console.error("\u274c failed to load accounts",e),O([])}try{const{data:e}=await c.A.get("api/payment-types",Ue());Q(e.data||e||[])}catch(e){console.error("\u274c failed to load payment types",e),Q([])}try{const{data:e}=await c.A.get("api/terminals",Ue());H(e.data||e||[])}catch(e){console.error("\u274c failed to load terminals",e),H([])}}(),Ke(),a?(S(!0),Ze(a).then((async e=>{e&&($(e.warehouse._id),await Je(e.warehouse._id),Be(e))})).catch(console.error).finally((()=>S(!1)))):Ve()}),[a]),(0,n.useEffect)((()=>{Je()}),[_]),(0,n.useEffect)((()=>{let e=0,t=0,a=0;ee.forEach((n=>{e+=n.quantity,t+=n.quantity*n.salesPrice,a+=n.discount||0})),ne(e),re(t),le(a)}),[ee]),(0,n.useEffect)((()=>{const e=V.trim();if(!e||!_)return X([]);const t=new RegExp(e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");const a=W.filter((e=>{var a,n;return(null===(a=e.warehouse)||void 0===a?void 0:a._id)===_&&(t.test(e.itemName)||t.test(e.itemCode)||t.test((null===(n=e.barcodes)||void 0===n?void 0:n.join(" "))||""))})).slice(0,15);X(a),console.log("Filtered items:",a)}),[V,_,W]),(0,n.useEffect)((()=>()=>{var e;const t=De.current;if(t)try{"function"===typeof t.reset?t.reset():"function"===typeof t.stopStreams&&t.stopStreams()}catch(a){console.error("Error during scanner cleanup:",a)}null!==(e=Te.current)&&void 0!==e&&e.srcObject&&Te.current.srcObject.getTracks().forEach((e=>e.stop()))}),[]),(0,n.useEffect)((()=>{const e=T.find((e=>e._id===E));pe((null===e||void 0===e?void 0:e.previousDue)||0)}),[E,T]),(0,n.useEffect)((()=>{var e,t;const a=A.find((e=>e._id===_));null!==a&&void 0!==a&&null!==(e=a.cashAccount)&&void 0!==e&&e._id?M(a.cashAccount._id):R.length&&M(null===(t=R[0])||void 0===t?void 0:t._id)}),[_,A,R]),(0,n.useEffect)((()=>{const e=Le&&T.length>0&&A.length>0&&R.length>0&&G.length>0&&W.length>0;console.log("\ud83d\udd0d hydrate ready?",{order:!!Le,cust:T.length,wh:A.length,accts:R.length,ptypes:G.length,items:W.length}),e&&(et(Le),Be(null))}),[Le,T,A,R,G,W]),(0,n.useEffect)((()=>{if(!a&&A.length)if(Re)$(Re);else{var e;const t=A.find((e=>e.isRestricted&&"Active"===e.status));$((null===t||void 0===t?void 0:t._id)||(null===(e=A.find((e=>"Active"===e.status)))||void 0===e?void 0:e._id)||"")}}),[A,Re,a]);async function tt(e){const t=await Xe(_,e.variantId||e._id);if(e.currentStock=t,t<=0)return void l().fire("Out of stock",`"${e.itemName}" is out of stock in this warehouse.`,"warning");if(!e||!e.parentId)return void console.error("Invalid item, missing parentId:",e);if(e.currentStock<=0)return void l().fire({icon:"warning",title:"Out of stock",text:`"${e.itemName}" is out of stock in this warehouse.`});if(!W.some((t=>t._id===e.parentId&&!t.variantId))&&!e.variantId)return void console.error(`Parent item not found for parentId: ${e.parentId}`,e);if(e.variantId){if(!W.some((t=>t._id===e.variantId&&t.parentId===e.parentId)))return void console.error(`Invalid variantId: ${e.variantId} for parentId: ${e.parentId}`,e)}const a=ee.findIndex((t=>t.item===e.parentId&&t.variant===(e.variantId||null)));if(-1!==a){const t=[...ee],n=t[a];if(n.quantity+1>e.currentStock)return void l().fire({icon:"warning",title:"Insufficient stock",text:`Only ${e.currentStock} unit${e.currentStock>1?"s":""} left for "${e.itemName}".`});t[a]={...n,quantity:n.quantity+1,subtotal:(n.quantity+1)*n.salesPrice-(n.discount||0)},te(t)}else{var n,s;const t={item:e.parentId,variant:e.variantId||null,itemName:e.itemName,itemCode:e.itemCode||"",openingStock:e.openingStock||0,currentStock:null!=e.currentStock?e.currentStock:e.openingStock||0,salesPrice:e.salesPrice||0,quantity:1,discount:e.discount||0,tax:(null===(n=e.tax)||void 0===n?void 0:n._id)||null,taxRate:(null===(s=e.tax)||void 0===s?void 0:s.taxPercentage)||0,unit:e.unit||null,mrp:e.mrp||0,expiryDate:e.expiryDate||null,subtotal:(e.salesPrice||0)-(e.discount||0)};if(t.salesPrice<=0)return void alert("Item sales price must be greater than zero.");te((e=>[...e,t]))}K(""),f()}async function at(e,t,a){if(""===a)return void te((a=>a.map(((a,n)=>n===e?{...a,[t]:""}:a))));const n=Number(a);if(isNaN(n))return;const s=ee[e],r="quantity"===t?n-s.quantity:0;if("quantity"===t){const t=ee[e],a=await Xe(_,t.variant||t.item),s=(t.origQty||0)+a;if(n>s)return void l().fire({icon:"warning",title:"Insufficient stock",text:`Only ${s} unit${s>1?"s":""} available for "${t.itemName}".`})}"salesPrice"===t&&n>s.mrp?l().fire({icon:"warning",title:"Price exceeds MRP",text:`Sales price \u20b9${n} is above MRP \u20b9${s.mrp}.`}):("quantity"===t||"salesPrice"===t)&&n<=0?l().fire({icon:"warning",title:"Invalid value",text:`${t.charAt(0).toUpperCase()+t.slice(1)} must be greater than zero.`}):(te((a=>a.map(((a,s)=>s===e?{...a,[t]:n,subtotal:("salesPrice"===t?n:a.salesPrice)*("quantity"===t?n:a.quantity)-("discount"===t?n:a.discount||0)}:a)))),"quantity"===t&&(r>0&&f(),r<0&&N()))}function nt(e){let{status:t,payments:a,paymentMode:n}=e;if(console.log("Building payload with:",{selectedWarehouse:_,selectedCustomer:E,selectedAccount:F,items:ee,status:t,paymentMode:n}),!_)throw new Error("Warehouse is required");if(!E)throw new Error("Customer is required");if(!F)throw new Error("Account is required");const s=ee.map((e=>W.some((t=>t.parentId===e.item&&(!e.variant||t._id===e.variant||t.variantId===e.variant)))?e.quantity<=0||e.salesPrice<=0?(console.error("Invalid quantity or price for item:",{itemId:e.item,itemName:e.itemName,quantity:e.quantity,price:e.salesPrice}),null):{item:e.item,variant:e.variant,quantity:e.quantity,origQty:e.origQty,price:e.salesPrice,discount:e.discount||0,unit:e.unit,tax:e.tax,subtotal:e.subtotal}:(console.error("Invalid item in payload:",{itemId:e.item,variantId:e.variant,itemName:e.itemName,itemCode:e.itemCode}),null))).filter((e=>null!==e)),r=[];if(s.forEach((e=>{const t=W.find((t=>{var a;return t.parentId===e.item&&(!e.variant||t._id===e.variant||t.variantId===e.variant)&&(null===(a=t.warehouse)||void 0===a?void 0:a._id)===_}));if(!t)return void r.push(`Item not found in warehouse (id: ${e.item}).`);const a=e.origQty||0,n=t.currentStock+a;e.quantity>n&&r.push(`"${t.itemName}" \u2013 requested ${e.quantity}, available ${n}`)})),r.length)throw l().fire({icon:"warning",title:"Insufficient stock",html:r.join("<br/>")}),new Error("Stock validation failed");if(0===s.length)throw new Error("No valid items to save. Please add valid items to the order.");const o={warehouse:_,customer:E,customerModel:Qe,account:F,items:s,totalAmount:se-oe,totalDiscount:oe,couponCode:he||void 0,payments:a,...L?{booking:L}:{},status:t,paymentMode:n,invoiceCount:ce,previousBalance:me,adjustAdvancePayment:ge,advancePaymentAmount:be};return console.log("Generated payload:",o),o}async function st(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"post",a=arguments.length>2?arguments[2]:void 0;const n=window.open("","_blank");n&&(n.document.write("<p style='font-family:Arial;padding:24px'>Generating invoice\u2026</p>"),n.document.close());try{const s=a?`api/pos/${a}`:"api/pos",{data:r}=await c.A[t](s,e,Ue()),o=T.find((e=>e._id===E))||{},i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"\u2013";const{logo:o,storeName:l,tagline:i,address:d,gst:c,phone:u,email:m}=a,p=new Date(e.createdAt||Date.now()),h=s.reduce(((e,t)=>e+t.quantity),0),x=s.reduce(((e,t)=>e+t.quantity*t.salesPrice),0),g=e.totalDiscount||0,v=e.taxAmount||0,b=x-g,y=t.reduce(((e,t)=>e+t.amount),0),f=e.previousBalance||0,N=f+b+v-y,j=s.map(((e,t)=>`\n    <tr>\n      <td>${t+1}</td>\n      <td>${e.itemName}</td>\n      <td class="r">${e.quantity}</td>\n      <td class="r">${e.mrp.toFixed(2)}</td>\n      <td class="r">${e.salesPrice.toFixed(2)}</td>\n      <td class="r">${(e.quantity*e.salesPrice).toFixed(2)}</td>\n    </tr>`)).join(""),w=t.map(((e,t)=>{return`\n    <tr><td>${t+1}</td><td>${e.paymentNote||"-"}</td><td class="r">${a=e.amount,(+a).toLocaleString("en-IN",{minimumFractionDigits:2})}</td></tr>`;var a})).join("");return`<!doctype html><html><head><meta charset="utf-8">\n  <title>${e.saleCode}</title>\n  <style>\n    *{font-family:Arial,Helvetica,sans-serif;font-size:11px;margin:0;padding:0;box-sizing:border-box}\n    body{padding:8px}\n    h2{font-size:18px;margin:4px 0}\n    .center{text-align:center}\n    .r{text-align:right}\n    table{width:100%;border-collapse:collapse;margin-top:4px}\n    th,td{border:1px solid #ddd;padding:4px}\n    th{background:#f7f7f7;}\n    .no-border td{border:none}\n    .sep{margin:6px 0;border-top:1px dashed #555}\n    @media print{@page{size:auto;margin:6mm}button{display:none}}\n    @media print {\n.noprint, .noprint * { display:none !important }}\n  </style></head><body>\n\n  \x3c!-- Header --\x3e\n  <div class="center">\n    <img src="${o}" alt="logo" style="height:45px"><br>\n    <h2>${l}</h2>\n    <strong>${i}</strong><br>\n    <div style="white-space:pre-line">${d}</div>\n    GST Number: ${c}<br>\n    Phone: ${u}<br>\n    ${m}\n  </div>\n\n  <div class="sep"></div>\n\n  \x3c!-- Invoice meta (two-column) --\x3e\n  <table class="no-border">\n    <tr><td><strong>Invoice</strong></td><td class="r">#${e.saleCode}</td></tr>\n    <tr><td><strong>Name</strong></td><td class="r">${n.customerName||"\u2013"}</td></tr>\n    <tr><td><strong>Seller</strong></td><td class="r">${r}</td></tr>\n    <tr><td><strong>Date</strong></td><td class="r">${p.toLocaleDateString()}</td></tr>\n    <tr><td><strong>Time</strong></td><td class="r">${p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</td></tr>\n  </table>\n\n  \x3c!-- Items --\x3e\n  <table>\n    <thead><tr>\n      <th>#</th><th>Description</th><th>Quantity</th>\n      <th>MRP</th><th>Rate</th><th>Total</th>\n    </tr></thead>\n    <tbody>${j}</tbody>\n  </table>\n\n  \x3c!-- Totals --\x3e\n  <table class="no-border">\n   <tr><td>Total Quantity</td><td class="r">${h}</td></tr>\n      <tr><td>Before Tax</td>       <td class="r">${x.toFixed(2)}</td></tr>\n      <tr><td>Total Discount</td>   <td class="r">\u2212${g.toFixed(2)}</td></tr>\n      <tr><td>Net Before Tax</td>   <td class="r">${b.toFixed(2)}</td></tr>\n      <tr><td>Tax Amount</td>       <td class="r">${v.toFixed(2)}</td></tr>\n      <tr><td><strong>Total</strong></td>\n          <td class="r"><strong>${(b+v).toFixed(2)}</strong></td></tr>\n      <tr><td>Paid Payment</td>     <td class="r">${y.toFixed(2)}</td></tr>\n      <tr><td>Previous Due</td>     <td class="r">${f.toFixed(2)}</td></tr>\n      <tr><td><strong>Total Due Amount</strong></td>\n          <td class="r"><strong>${N.toFixed(2)}</strong></td></tr>\n\n  </table>\n\n  \x3c!-- Payments --\x3e\n  <p style="margin-top:6px"><strong>Note:</strong></p>\n  <table><thead><tr><th>#</th><th>Payment Type</th><th>Amount</th></tr></thead>\n    <tbody>${w||'<tr><td colspan="3" class="center">\u2013</td></tr>'}</tbody>\n  </table>\n\n  <p style="margin-top:8px"><strong>Invoice T&amp;C:</strong></p>\n  <div class="sep"></div>\n  <p class="center" style="margin-top:4px">----------Thanks You. Visit Again!----------</p>\n\n  <button class="noprint" onclick="window.print()" style="margin:12px auto;display:block;padding:6px 18px">Print</button>\n  <script>window.onload=()=>setTimeout(()=>window.print(),200)<\/script>\n  </body></html>`}(r.order,e.payments,it,o,ee,lt(b));n&&(n.document.open(),n.document.write(i),n.document.close()),de(r.order.saleCode),rt(),Ke(),l().fire("Saved!","","success")}catch(o){var s,r;n&&n.close(),console.error("Send order error details:",o),l().fire("Error",(null===(s=o.response)||void 0===s||null===(r=s.data)||void 0===r?void 0:r.message)||o.message,"error")}}function rt(){var e,t,a;te([]),ne(0),re(0),le(0),Ve(),ue(0),pe(0),xe(""),ve(!1),ye(0),Se(""),q((null===(e=T[0])||void 0===e?void 0:e._id)||""),$((null===(t=A[0])||void 0===t?void 0:t._id)||""),M((null===(a=R[0])||void 0===a?void 0:a._id)||""),$e("")}async function ot(e){if(!a)for(const a of ee){const e=await Xe(_,a.variant||a.item);if(a.quantity>e)return void l().fire("Stock changed",`"${a.itemName}" now has only ${e} left. Please adjust your cart.`,"warning")}if(a&&"multiple"!==e||_&&E&&F)if(ee.length)if("cash"===e||"bank"===e){const a=Ye(e);if(!a)return void alert(`Missing payment type: ${e.charAt(0).toUpperCase()+e.slice(1)}. Please ensure it is configured.`);const n={paymentType:a,amount:se-oe,paymentNote:`${e.charAt(0).toUpperCase()+e.slice(1)} payment`};"bank"===e&&z.length>0&&(n.terminal=z[0]._id);try{st(nt({status:"Completed",payments:[n],paymentMode:e}),Ce?"put":"post",Ce)}catch(t){alert(t.message)}}else Ie(e),Ge(function(e){var t;const a=A.find((e=>e._id===_));if(!a)return[];const n=null===(t=a.cashAccount)||void 0===t?void 0:t._id,s=R.filter((e=>"Bank"===e.accountType));if("cash"===e){const e=R.find((e=>e._id===F));return[...R.filter((e=>e._id===n)),...e&&e._id!==n?[e]:[]]}return"multiple"===e?[...R.filter((e=>e._id===n)),...s]:s}(e)),Pe(!0);else alert("Please add at least one item to the order.");else alert("Please select a warehouse, customer, and account before proceeding with payment.")}const lt=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(null===(e=t.name)||void 0===e?void 0:e.trim())||[t.FirstName,t.LastName].filter(Boolean).join(" ").trim()||t.userName||t.Mobile||"\u2013"},it={logo:"/logo/inspiredgrow.jpg",storeName:Ee,tagline:"GROCERY ON WHEELS",address:"Basement 210-211 new Rishi Nagar near\nShree Shyam Baba Mandir Gali No. 9, Hisar \u2013 125001",gst:"06AAGCI0630K1ZR",phone:"9050092092",email:"INSPIREDGROW@GMAIL.COM"};async function dt(t){window.confirm("Delete this held invoice?")&&await async function(t){try{await c.A.delete(`api/pos/${t}`,Ue()),Ne((e=>e.filter((e=>e._id!==t)))),e("/sale-list")}catch(a){console.error("Delete POS transaction error:",a.message),alert(`Failed to delete POS order: ${a.message}`)}}(t)}const ct={totalItems:ae,totalPrice:se,discount:oe,couponDiscount:0,totalPayable:se-oe,totalPaying:0,balance:se-oe,changeReturn:0},ut="hold"===_e?"border-4 border-yellow-400 shadow-lg":"border border-gray-300",mt="multiple"===_e?"border-4 border-yellow-400 shadow-lg":"border border-gray-300",pt="cash"===_e?"border-4 border-yellow-400 shadow-lg":"border border-gray-300",ht="bank"===_e?"border-4 border-yellow-400 shadow-lg":"border border-gray-300";return C?(0,m.jsx)(h.A,{}):(0,m.jsxs)("div",{className:"flex flex-col min-h-screen bg-gray-100",children:[(0,m.jsxs)("nav",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-gray-800 to-gray-900 text-white shadow-lg",children:[(0,m.jsxs)("div",{className:"flex items-center gap-4",children:[(0,m.jsx)("h1",{className:"text-xl font-bold cursor-pointer hover:text-yellow-400 transition-colors",onClick:()=>e("/dashboard"),children:Ee||"Grocery on Wheels"}),(0,m.jsx)("button",{className:"md:hidden text-2xl hover:text-yellow-400 transition-colors",onClick:()=>we((e=>!e)),children:(0,m.jsx)(s.OXb,{})}),(0,m.jsxs)("div",{className:"hidden md:flex gap-4",children:[(0,m.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer hover:text-yellow-400 transition-colors",onClick:()=>e("/sale-list"),children:[(0,m.jsx)(s.svy,{className:"text-yellow-500"})," Sales List"]}),(0,m.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer hover:text-yellow-400 transition-colors",onClick:()=>e("/customer/view"),children:[(0,m.jsx)(s.YXz,{className:"text-yellow-500"})," Customers"]}),(0,m.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer hover:text-yellow-400 transition-colors",onClick:()=>e("/item-list"),children:[(0,m.jsx)(s.TXh,{className:"text-yellow-500"})," Items"]}),(0,m.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer hover:text-yellow-400 transition-colors",onClick:rt,children:[(0,m.jsx)(s.TlC,{className:"text-yellow-500"})," New Invoice"]})]})]}),(0,m.jsxs)("div",{className:"hidden md:flex items-center gap-4",children:[(0,m.jsxs)("div",{className:"relative cursor-pointer text-sm hover:text-yellow-400 transition-colors",onClick:()=>we((e=>!e)),children:["Hold List"," ",(0,m.jsx)("span",{className:"absolute -top-2 -right-3 bg-red-600 px-2 py-1 text-xs rounded-full",children:fe.length})]}),(0,m.jsx)(s.U_c,{className:"cursor-pointer text-xl hover:text-yellow-400 transition-colors",onClick:function(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(console.error)}}),(0,m.jsxs)("div",{className:"relative flex items-center gap-2 cursor-pointer",onClick:()=>P((e=>!e)),children:[(0,m.jsx)("img",{src:"/userlogoprof.png",alt:"Profile",className:"w-10 h-10 rounded-full border-2 border-gray-300 shadow-sm"}),(0,m.jsx)("span",{className:"hover:text-yellow-400 transition-colors",children:j?"Loading...":b.name}),k&&(0,m.jsxs)("div",{className:"absolute top-full right-0 w-64 p-4 bg-white text-black rounded-lg shadow-xl border border-gray-200 z-20",children:[(0,m.jsxs)("div",{className:"flex flex-col items-center",children:[(0,m.jsx)("img",{src:"/userlogoprof.png",alt:"Profile",className:"w-16 h-16 rounded-full border-2 border-gray-400 shadow-sm"}),(0,m.jsx)("h3",{className:"mt-2 font-bold text-gray-800",children:b.name}),(0,m.jsxs)("p",{className:"text-sm text-blue-600",children:["Role: ",b.role]})]}),(0,m.jsxs)("div",{className:"mt-4 flex flex-col gap-2",children:[(0,m.jsx)("button",{className:"px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors",children:"Profile"}),(0,m.jsx)("button",{onClick:function(){localStorage.clear(),e("/"),window.location.reload()},className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors",children:"Sign Out"})]})]})]}),(0,m.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer hover:text-yellow-400 transition-colors",onClick:()=>e("/dashboard"),children:[(0,m.jsx)(i.Qkn,{className:"text-yellow-500"})," Dashboard"]})]})]}),je&&(0,m.jsxs)("div",{className:"absolute top-16 right-4 w-80 p-4 bg-white rounded-lg shadow-xl border border-gray-200 z-20",children:[(0,m.jsx)("h3",{className:"mb-3 font-bold text-gray-800 text-lg",children:"Held Invoices"}),fe.length?fe.map((e=>{var t,a,n;return(0,m.jsxs)("div",{className:"flex justify-between items-center p-3 mb-2 bg-white rounded-lg border-l-4 border-cyan-500 hover:bg-gray-50 transition",children:[(0,m.jsxs)("div",{className:"flex flex-col",children:[(0,m.jsx)("span",{className:"font-semibold text-gray-800",children:e.saleCode||(null===(t=e.items)||void 0===t||null===(a=t[0])||void 0===a?void 0:a.itemName)||e._id.slice(0,6)}),(null===(n=e.items)||void 0===n?void 0:n.length)>1&&(0,m.jsxs)("span",{className:"text-xs text-gray-500",children:["+",e.items.length-1," more item",e.items.length-1>1?"s":""]})]}),(0,m.jsxs)("div",{className:"flex gap-2",children:[(0,m.jsx)("button",{onClick:()=>async function(e){const t=await Ze(e);t&&(et(t),we(!1))}(e._id),className:"text-blue-600 hover:text-blue-800 font-medium",children:"Edit"}),(0,m.jsx)("button",{onClick:()=>dt(e._id),className:"text-red-600 hover:text-red-800 font-medium",children:"Delete"})]})]},e._id)})):(0,m.jsx)("p",{className:"text-gray-500 text-sm",children:"No held invoices"})]}),(0,m.jsxs)("div",{className:"flex flex-col lg:flex-row flex-grow gap-6 p-6",children:[(0,m.jsxs)("div",{className:"lg:w-2/3 w-full p-6 bg-white rounded-xl shadow-lg border-t-4 border-cyan-500",children:[(0,m.jsxs)("div",{className:"flex flex-col gap-5",children:[(0,m.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,m.jsxs)("select",{className:"border border-gray-300 p-3 rounded-lg bg-gray-50 text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition-all",value:_,onChange:e=>$(e.target.value),children:[(0,m.jsx)("option",{value:"",children:"Select Warehouse"}),A.filter((e=>"Active"===e.status)).map((e=>(0,m.jsx)("option",{value:e._id,children:e.warehouseName},e._id)))]}),(0,m.jsx)("input",{className:"border border-gray-300 p-3 rounded-lg bg-gray-100 text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition-all",readOnly:!0,value:ie})]}),(0,m.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,m.jsxs)("div",{className:"flex items-center border border-gray-300 rounded-lg bg-gray-50",children:[(0,m.jsxs)("select",{className:"flex-grow border-none p-3 bg-transparent text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition-all",value:E,onChange:e=>q(e.target.value),children:[(0,m.jsx)("option",{value:"",children:"Select Customer"}),T.map((e=>(0,m.jsx)("option",{value:e._id,children:e.customerName},e._id)))]}),(0,m.jsx)("button",{type:"button",onClick:()=>{console.log("Plus button clicked!"),ze(!0)},title:"Add new customer",className:"px-3 py-2 text-lg font-bold text-blue-600 border-l hover:bg-gray-100",children:"+"})]}),(0,m.jsxs)("div",{className:"relative flex items-center border border-gray-300 rounded-lg p-3 bg-gray-50",children:[(0,m.jsx)(s.SCC,{className:"text-gray-500 mr-3"}),(0,m.jsx)("input",{className:"flex-grow text-gray-700 focus:outline-none bg-transparent",placeholder:"Item name / Barcode / Item code",value:V,onChange:e=>{const t=e.target.value.trim();K(t);const a=W.find((e=>{var a;return null===(a=e.barcodes)||void 0===a?void 0:a.includes(t)}));a&&(tt(a),K(""))},onKeyDown:e=>{"Enter"===e.key&&e.preventDefault(),"Enter"===e.key&&Y[0]&&(tt(Y[0]),K(""))}}),(0,m.jsx)("button",{disabled:!_,onClick:()=>{if(!_)return void alert("Select a warehouse first");J(!0);const e=new r.sx;De.current=e;let t=null,a=0;e.decodeFromConstraints({video:{facingMode:{exact:"environment"}}},Te.current,((n,s)=>{if(n){const e=n.getText(),s=Date.now();if(e!==t||s-a>1e3){t=e,a=s;const n=W.find((t=>{var a;return t.itemCode===e||(null===(a=t.barcodes)||void 0===a?void 0:a.includes(e))||t.itemName.toLowerCase()===e.toLowerCase()}));n&&tt(n),K(""),f()}}s&&"NotFoundException"!==s.name&&(console.error(s),alert("Scanning failed: "+s.message),e.reset(),J(!1))}))},className:"ml-2 rounded-full p-2 transition-all "+(_?"hover:bg-blue-600 text-white bg-blue-500":"text-gray-400 cursor-not-allowed"),children:(0,m.jsx)(d.A,{className:"w-5 h-5"})}),V&&Y.length>0&&(0,m.jsx)("ul",{className:"absolute top-full left-0 w-full max-h-60 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg z-10",children:Y.map((e=>{var t;return(0,m.jsxs)("li",{className:"p-3 hover:bg-gray-100 cursor-pointer transition-colors",onClick:()=>tt(e),children:[(0,m.jsx)("strong",{className:"text-gray-800",children:e.itemCode})," - ",e.itemName,(null===(t=e.barcodes)||void 0===t?void 0:t.length)>0&&(0,m.jsxs)("span",{className:"text-gray-500",children:[" (",e.barcodes[0],")"]})]},e._id)}))}),Z&&(0,m.jsxs)("div",{className:"fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-50",children:[(0,m.jsx)("div",{className:"w-72 h-72 border-4 border-white rounded-lg overflow-hidden",children:(0,m.jsx)("video",{ref:Te,className:"object-cover w-full h-full",autoPlay:!0,muted:!0,playsInline:!0})}),(0,m.jsx)("button",{onClick:()=>{var e;const t=De.current;null!==t&&void 0!==t&&t.reset?t.reset():null!==t&&void 0!==t&&t.stopStreams&&t.stopStreams(),null!==(e=Te.current)&&void 0!==e&&e.srcObject&&Te.current.srcObject.getTracks().forEach((e=>e.stop())),J(!1)},className:"mt-4 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Close"})]})]}),(0,m.jsx)("input",{className:"border border-gray-300 p-3 rounded-lg bg-gray-100 text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition-all",readOnly:!0,value:_e?`Payment Method: ${_e.charAt(0).toUpperCase()+_e.slice(1)}`:"",placeholder:"Payment Method: None"})]})]}),Me&&(0,m.jsx)(v,{open:Me,onClose:()=>ze(!1),onCreated:e=>{D((t=>[...t,e])),q(e._id),ze(!1)}}),(0,m.jsxs)("div",{className:"mt-4 text-red-600 font-medium",children:["Previous Due: \u20b9",me.toFixed(2)]}),(0,m.jsx)("div",{className:"mt-6 overflow-x-auto border border-gray-200 rounded-lg shadow-sm",children:(0,m.jsxs)("table",{className:"min-w-full bg-white",children:[(0,m.jsx)("thead",{className:"bg-gray-200 text-gray-700 text-sm",children:(0,m.jsx)("tr",{children:["Item Name","Stock","Quantity","Sales Price","MRP","Total \u20b9","Remove"].map((e=>(0,m.jsx)("th",{className:"px-4 py-3 text-left font-semibold border-b",children:e},e)))})}),(0,m.jsx)("tbody",{className:"text-gray-600 text-sm",children:ee.length?ee.map(((e,t)=>(0,m.jsxs)("tr",{className:"border-b hover:bg-gray-50 transition-colors",children:[(0,m.jsx)("td",{className:"px-4 py-3",children:e.itemName}),(0,m.jsx)("td",{className:"px-4 py-3",children:e.currentStock}),(0,m.jsx)("td",{className:"px-4 py-3",children:(0,m.jsx)("input",{type:"number",min:"1",className:"w-16 text-center border rounded",value:e.quantity,onChange:e=>at(t,"quantity",e.target.value)})}),(0,m.jsx)("td",{className:"px-4 py-3",children:(0,m.jsx)("input",{type:"number",min:"0",className:"w-20 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-400 focus:outline-none",value:e.salesPrice,onChange:e=>at(t,"salesPrice",e.target.value)})}),(0,m.jsx)("td",{className:"px-4 py-3",children:e.mrp}),(0,m.jsx)("td",{className:"px-4 py-3 text-center font-semibold",children:(e.quantity*e.salesPrice).toFixed(2)}),(0,m.jsx)("td",{className:"px-4 py-3",children:(0,m.jsx)("button",{className:"text-red-500 hover:text-red-700 font-medium transition-colors",onClick:()=>{return e=t,N(),void te((t=>t.filter(((t,a)=>a!==e))));var e},children:"Remove"})})]},t))):(0,m.jsx)("tr",{children:(0,m.jsx)("td",{colSpan:"11",className:"py-6 text-center text-red-500 font-medium",children:"No Items Added"})})})]})}),(0,m.jsxs)("div",{className:"mt-6 p-4 bg-gray-100 border-t rounded-b-lg flex flex-wrap justify-center gap-4",children:[(0,m.jsxs)("button",{onClick:async function(){const{isConfirmed:e}=await l().fire({title:"Put order on hold?",text:"Are you sure you want to add this order to held invoices?",icon:"question",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, Hold"});if(!e)return;if(!_||!E||!F)return void l().fire("Missing data","Warehouse, customer and account are required.","warning");const t=Ye("Hold");if(!t)return void l().fire("Config error","Payment type 'Hold' is missing.","error");const a={warehouse:_,customer:E,account:F,items:ee.map((e=>({item:e.item,variant:e.variant||null,quantity:e.quantity,price:e.salesPrice,discount:e.discount||0,unit:e.unit,tax:e.tax,subtotal:e.subtotal}))),totalAmount:se-oe,totalDiscount:oe,payments:[{paymentType:t,amount:se-oe,paymentNote:"Hold payment"}],status:"OnHold",paymentMode:"hold",invoiceCount:ce,previousBalance:me,adjustAdvancePayment:ge,advancePaymentAmount:be,couponCode:he||void 0};try{const e=localStorage.getItem("token");Ce?await c.A.put(`api/pos/${Ce}`,a,{headers:{Authorization:`Bearer ${e}`}}):await c.A.post("api/pos",a,{headers:{Authorization:`Bearer ${e}`}}),await Ke(),l().fire("Held!","Order has been moved to held invoices.","success")}catch(r){var n,s;console.error("Hold error:",r),l().fire("Error",(null===(n=r.response)||void 0===n||null===(s=n.data)||void 0===s?void 0:s.message)||r.message,"error")}},className:`flex items-center justify-center gap-2 px-6 py-3 text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-md transition-all duration-200 ${ut}`,children:[(0,m.jsx)(s.XzC,{})," Hold"]}),(0,m.jsxs)("button",{onClick:()=>ot("multiple"),className:`flex items-center justify-center gap-2 px-6 py-3 text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition-all duration-200 ${mt}`,children:[(0,m.jsx)(s.aQJ,{})," Multiple"]}),(0,m.jsxs)("button",{onClick:()=>ot("cash"),className:`flex items-center justify-center gap-2 px-6 py-3 text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition-all duration-200 ${pt}`,children:[(0,m.jsx)(s.XVP,{})," Cash"]}),(0,m.jsxs)("button",{onClick:()=>ot("bank"),className:`flex items-center justify-center gap-2 px-6 py-3 text-white bg-purple-600 hover:bg-purple-700 rounded-lg shadow-md transition-all duration-200 ${ht}`,children:[(0,m.jsx)(s.x1c,{})," Bank"]})]})]}),(0,m.jsxs)("div",{className:"lg:w-1/3 w-full p-6 bg-white rounded-xl shadow-lg border-l-4 border-cyan-500",children:[[["Quantity:",ae],["Total Amount (\u20b9):",se.toFixed(2)],["Total Discount (\u20b9):",oe.toFixed(2)],["Grand Total (\u20b9):",(se-oe).toFixed(2)]].map((e=>{let[t,a]=e;return(0,m.jsxs)("div",{className:"flex justify-between mb-4 text-gray-700 text-lg",children:[(0,m.jsx)("span",{className:"font-semibold",children:t}),(0,m.jsx)("span",{children:a})]},t)})),(0,m.jsxs)("div",{className:"mt-6",children:[(0,m.jsx)("label",{className:"block mb-2 text-lg font-semibold text-gray-800",children:"Coupon Code"}),(0,m.jsx)("input",{type:"text",className:"w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition-all",placeholder:"Enter Coupon Code",value:he,onChange:e=>xe(e.target.value)})]})]})]}),ke&&(0,m.jsx)(p,{onClose:()=>Pe(!1),paymentMode:Ae,paymentTypes:G,accounts:He,terminals:z,initialAdvance:be,initialAccount:F,initialSummary:ct,selectedWarehouse:_,onSubmit:e=>{let{paymentRows:t,couponCode:a,adjustAdvancePayment:n,advance:s,selectedAccount:r}=e;st(nt({status:"Completed",payments:t,paymentMode:Ae}),Ce?"put":"post",Ce),xe(a||""),ve(n),ye(s),M(r)}})]})}},14840:(e,t,a)=>{a.d(t,{A:()=>l});var n=a(65043),s=a(21197),r=a(59255),o=a(70579);function l(){const[e,t]=(0,n.useState)(!1);return(0,o.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,o.jsx)(s.A,{isSidebarOpen:e,setSidebarOpen:t}),(0,o.jsxs)("div",{className:"flex flex-grow mt-20",children:[(0,o.jsx)("div",{children:(0,o.jsx)(r.A,{isSidebarOpen:e})}),(0,o.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm",children:(0,o.jsxs)("div",{className:"flex flex-col items-center",children:[(0,o.jsx)("div",{className:"w-12 h-12 border-4 rounded-full border-cyan-500 border-t-transparent animate-spin"}),(0,o.jsx)("p",{className:"mt-3 text-lg font-semibold text-gray-700",children:"Loading..."})]})})]})]})}}}]);
//# sourceMappingURL=4477.1bea944e.chunk.js.map