"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[7772],{47772:(e,t,a)=>{a.r(t),a.d(t,{default:()=>p});var s=a(65043),r=a(21197),l=a(59255),n=a(49804),o=a(60184),i=a(86213),c=a(11238),d=a(66727),u=a(70579);function m(e){let{files:t,onRemove:a}=e;const[r,l]=(0,s.useState)(!1),n=r?t:t.slice(0,50);return(0,u.jsxs)("div",{className:"mt-3 border rounded p-3 bg-gray-50",children:[(0,u.jsxs)("header",{className:"flex justify-between items-center mb-2",children:[(0,u.jsxs)("span",{className:"font-semibold text-sm",children:["Selected files: ",t.length]}),t.length>50&&(0,u.jsx)("button",{type:"button",className:"text-cyan-600 text-xs underline",onClick:()=>l(!r),children:r?"Collapse":`Show all (${t.length})`})]}),(0,u.jsxs)("ul",{className:"max-h-64 overflow-y-auto text-sm space-y-1 pr-2",children:[n.map(((e,t)=>(0,u.jsxs)("li",{className:"flex justify-between",children:[(0,u.jsx)("span",{className:"truncate",children:e.name}),(0,u.jsx)("button",{type:"button",onClick:()=>a(t),className:"ml-2 text-red-500 hover:text-red-700 shrink-0",children:"Remove"})]},t))),!r&&t.length>50&&(0,u.jsxs)("li",{className:"text-center text-xs text-gray-500",children:["\u2026and ",t.length-50," more"]})]})]})}const h="";function p(){const[e,t]=(0,s.useState)(null),[a,p]=(0,s.useState)([]),[f,x]=(0,s.useState)([]),[N,E]=(0,s.useState)([]),[g,w]=(0,s.useState)([]),[b,v]=(0,s.useState)([]),[I,A]=(0,s.useState)(""),[T,C]=(0,s.useState)(!1),[O,S]=(0,s.useState)(!0),[j,y]=(0,s.useState)(!0),[R,P]=(0,s.useState)({current:0,total:0,phase:"idle"}),M=(0,s.useRef)({}),U=(0,d.Zp)(),L=localStorage.getItem("token")||"",G=(0,s.useRef)({headers:{"Content-Type":"application/json",Authorization:`Bearer ${L}`}}),D=(0,s.useRef)({units:{},brands:{},taxes:{}}),Y=e=>String(null!==e&&void 0!==e?e:"").trim();(0,s.useEffect)((()=>{window.innerWidth<768&&y(!1),Promise.all([i.A.get(`${h}/api/warehouses`,G.current),i.A.get(`${h}/api/categories`,G.current),i.A.get(`${h}/api/subcategories`,G.current),i.A.get(`${h}/api/sub-subcategories`,G.current)]).then((e=>{let[t,a,s,r]=e;x((t.data.data||t.data).filter((e=>"Active"===e.status))),E(a.data.data||a.data),w(s.data.data||s.data),v(r.data.data||s.data)})).catch((()=>alert("Failed to load lookup data. Refresh to retry."))).finally((()=>S(!1)))}),[]),(0,s.useEffect)((()=>{i.A.get(`${h}/api/items/available-images`,G.current).then((e=>{M.current=e.data||{}})).catch((()=>{}))}),[]);const $=async function(e,t,a){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!a)return;const r=Y(a);if(D.current[e]=D.current[e]||{},D.current[e][r])return D.current[e][r];const l=(await i.A.get(`${h}/api/${e}?search=${encodeURIComponent(r)}`,G.current).then((e=>e.data.data||e.data)).catch((()=>[]))).find((e=>Y(e[t]).toLowerCase()===r.toLowerCase()));let n=null===l||void 0===l?void 0:l._id;if(!n){const a={[t]:r};"taxes"===e&&(a.taxPercentage=Number(s.value)||0,a.type=s.type||"percentage"),n=await i.A.post(`${h}/api/${e}`,a,G.current).then((e=>{var t;return null===(t=e.data.data||e.data)||void 0===t?void 0:t._id})).catch((()=>null))}return D.current[e][r]=n,n};if(T)return(0,u.jsxs)("div",{className:"flex flex-col items-center justify-center h-screen bg-gray-100",children:[(0,u.jsxs)("div",{className:"text-2xl font-semibold text-gray-700",children:["validating"===R.phase&&"Validating CSV Rows...","uploading"===R.phase&&"Uploading Images...","importing"===R.phase&&"Importing Items...","finalizing"===R.phase&&"Finalizing Import..."]}),(0,u.jsxs)("div",{className:"text-lg text-gray-600 mt-2",children:[Math.round(R.current),"% Complete"]}),(0,u.jsx)("div",{className:"w-64 bg-gray-200 rounded-full h-2.5 mt-4 overflow-hidden",children:(0,u.jsx)("div",{className:"bg-green-500 h-2.5 rounded-full transition-all duration-300",style:{width:`${R.current}%`}})})]});return(0,u.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,u.jsx)(r.A,{isSidebarOpen:j,setSidebarOpen:y}),(0,u.jsxs)("div",{className:"flex flex-grow",children:[(0,u.jsx)(l.A,{isSidebarOpen:j}),(0,u.jsxs)("div",{className:"flex-grow p-4 bg-gray-100 overflow-y-auto",children:[(0,u.jsxs)("header",{className:"flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded shadow mb-4",children:[(0,u.jsx)("h1",{className:"text-xl font-semibold",children:"Import Items (Bulk CSV)"}),(0,u.jsxs)("nav",{className:"flex items-center space-x-2 text-sm text-gray-600",children:[(0,u.jsxs)("a",{href:"/dashboard",className:"hover:text-cyan-600 flex items-center",children:[(0,u.jsx)(o.$BV,{className:"mr-1"})," Home"]}),(0,u.jsx)(n.XWt,{}),(0,u.jsx)("a",{href:"/item-list",className:"hover:text-cyan-600",children:"Items List"})]})]}),(0,u.jsxs)("div",{className:"bg-white p-6 rounded shadow space-y-4",children:[(0,u.jsxs)("div",{children:[(0,u.jsxs)("label",{className:"block mb-1 font-semibold",children:["Warehouse ",(0,u.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,u.jsxs)("select",{className:"w-full md:w-1/2 p-2 border rounded",value:I,onChange:e=>A(e.target.value),children:[(0,u.jsx)("option",{value:"",children:"Select Warehouse"}),f.map((e=>(0,u.jsx)("option",{value:e._id,children:e.warehouseName},e._id)))]})]}),(0,u.jsxs)("div",{children:[(0,u.jsxs)("label",{className:"block mb-1 font-semibold",children:["Import CSV ",(0,u.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,u.jsx)("input",{type:"file",accept:".csv",onChange:e=>t(e.target.files[0]||null),className:"w-full md:w-1/2 p-2 border rounded"}),(0,u.jsx)("p",{className:"text-sm text-red-500 mt-1",children:"Column names must match the list below. IMAGE CODE can be anywhere in the filename."})]}),(0,u.jsxs)("div",{children:[(0,u.jsx)("label",{className:"block mb-1 font-semibold",children:"Upload Images (Optional)"}),(0,u.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{const t=Array.from(e.target.files);if(t.length+a.length>2e4)alert("You can upload up to 20,000 images in total.");else{for(const e of t)if(e.size>10485760)return void alert(`File ${e.name} exceeds the 10 MB limit.`);p((e=>[...e,...t]))}},className:"w-full md:w-1/2 p-2 border rounded"}),(0,u.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Max 20k files, 10 MB each. Importer links files whose names contain the IMAGE CODE for items with OPENING STOCK greater than 0."}),a.length>0&&(0,u.jsxs)("div",{className:"mt-2",children:[(0,u.jsx)("p",{className:"text-sm font-semibold",children:"Uploaded Files:"}),(0,u.jsx)(m,{files:a,onRemove:e=>p((t=>t.filter(((t,a)=>a!==e))))})]})]}),(0,u.jsxs)("div",{className:"flex space-x-2",children:[(0,u.jsx)("button",{onClick:async()=>{if(O)return alert("Loading lookup data; please wait...");if(!I)return alert("Please select a warehouse.");if(!e)return alert("Please choose a CSV file.");C(!0),P({current:0,total:100,phase:"validating"});try{const r=await e.arrayBuffer(),l=c.read(r,{type:"array"}),n=c.utils.sheet_to_json(l.Sheets[l.SheetNames[0]],{defval:"",raw:!1}),o=n.length;P({current:5,total:100,phase:"validating"});const d=new Set;n.forEach((e=>{const t=Number(e["OPENING STOCK"]||0),a=Y(e["IMAGE CODE"]);a&&t>0&&d.add(a.toLowerCase())}));let u={...M.current};const m=a.filter((e=>{const t=e.name.replace(/\.[^.]+$/,"").toLowerCase();return[...d].some((e=>t.includes(e)))}));if(a.length&&!m.length&&alert("None of the selected images are referenced in the CSV; they'll be skipped."),m.length){const e=1e3,t=m.length;let a=0;for(let s=0;s<t;s+=e){const r=m.slice(s,s+e),l=new FormData;r.forEach((e=>l.append("itemImages",e)));const n=await i.A.post(`${h}/api/items/upload-images`,l,{headers:{Authorization:`Bearer ${L}`,"Content-Type":"multipart/form-data"}});if(!n.data.success)throw new Error(n.data.message||"Image upload failed");Object.assign(u,n.data.uploadedImages||{}),a+=r.length,P({current:20+a/t*20,total:100,phase:"uploading"})}}const p=[],f=[],x=[];P({current:40,total:100,phase:"validating"});for(let e=0;e<n.length;e++)try{const t=n[e],a=Y(t["CATEGORY NAME"]),s=N.find((e=>e.name.toLowerCase()===a.toLowerCase()));if(!s)throw new Error(`Category "${t["\u7535\u7ad9CATEGORY NAME"]}" not found`);let r,l;const i=Y(t["SUB CATEGORY NAME"]).toLowerCase(),c=Y(t["SUB SUBCATEGORY NAME"]).toLowerCase();if(i){const e=g.find((e=>e.name.toLowerCase()===i));if(!e)throw new Error(`SubCategory "${t["SUB CATEGORY NAME"]}" not found`);r=e._id}if(c){const e=b.find((e=>e.name.toLowerCase()===c));if(!e)throw new Error(`SubSubCategory "${t["SUB SUBCATEGORY NAME"]}" not found`);l=e._id}const d=await $("units","unitName",t["UNIT NAME"]),m=await $("brands","brandName",t["BRAND NAME"]),h=await $("taxes","taxName",t["TAX NAME"],{value:t["TAX VALUE"],type:t["TAX TYPE"]});if(!d||!h)throw new Error("Missing unit/tax id");const f=e=>/e\+/i.test(e)?Number(e).toLocaleString("fullwide",{useGrouping:!1}):e,x=Y(t.BARCODES).split(",").map((e=>f(Y(e)))).filter(Boolean),E=Y(t["IMAGE CODE"]);let w=[];if(E&&Number(t["OPENING STOCK"]||0)>0&&(w=Object.entries(u).filter((e=>{let[t]=e;return t.replace(/\.[^.]+$/,"").toLowerCase().includes(E.toLowerCase())})).flatMap((e=>{let[,t]=e;return Array.isArray(t)?t:[t]})),!w.length))throw new Error(`No uploaded images contain IMAGE CODE "${E}"`);let v=t["EXPIRY DATE"];if(v="number"===typeof v?new Date(86400*(v-25569)*1e3).toISOString():v?new Date(v).toISOString():null,!Y(t["ITEM NAME"]))throw new Error("ITEM NAME is required");if(!a)throw new Error("CATEGORY NAME is required");if(!Y(t["UNIT NAME"]))throw new Error("UNIT NAME is required");if(!Y(t["TAX NAME"]))throw new Error("TAX NAME is required");if(void 0===t["TAX VALUE"]||""===t["TAX VALUE"])throw new Error("TAX VALUE is required");if(!Y(t["TAX TYPE"]))throw new Error("TAX TYPE is required");if(void 0===t["PRICE WITHOUT TAX"]||""===t["PRICE WITHOUT TAX"])throw new Error("PRICE WITHOUT TAX is required");if(void 0===t["SALES PRICE"]||""===t["SALES PRICE"])throw new Error("SALES PRICE is required");if(void 0===t["OPENING STOCK"]||""===t["OPENING STOCK"])throw new Error("OPENING STOCK is required");p.push({itemCode:Y(t["ITEM CODE"]),itemName:Y(t["ITEM NAME"]),category:s._id,subCategory:r,subSubCategory:l,itemGroup:Y(t["ITEM GROUP"])||"Single",unit:d,brand:m,tax:h,sku:Y(t.SKU),hsn:Y(t.HSN),barcodes:x,priceWithoutTax:Number(t["PRICE WITHOUT TAX"]||0),purchasePrice:Number(t["PURCHASE PRICE"]||0),salesPrice:Number(t["SALES PRICE"]||0),mrp:Number(t.MRP||0),openingStock:Number(t["OPENING STOCK"]||0),alertQuantity:Number(t["ALERT QTY"]||0),sellerPoints:Number(t["SELLER POINTS"]||0),discountType:Y(t["DISCOUNT TYPE"]).toLowerCase().includes("flat")?"Fixed":"Percentage",discount:Number(t.DISCOUNT||0),discountPolicy:Y(t["DISCOUNT POLICY"])||"None",requiredQuantity:Number(t["REQUIRED QUANTITY"]||0),freeQuantity:Number(t["FREE QUANTITY"]||0),warehouse:I,description:Y(t["ITEM DESCRIPTION"]),expiryDate:v,itemImages:w,imageCode:E,isOnline:!["offline","no","0"].includes(Y(t.VISIBILITY).toLowerCase())}),P({current:40+(e+1)/o*20,total:100,phase:"validating"}),await new Promise((e=>setTimeout(e,0)))}catch(s){f.push(`Row ${e+1}: ${s.message}`),x.push({...n[e],ERROR:s.message,ROW_NUMBER:e+1})}if(x.length){const e=c.utils.sheet_to_csv(c.utils.json_to_sheet(x)),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(t),a.download="failed_imports.csv",a.click()}if(!p.length)throw new Error("No valid items to import");const E=200;let w=0;const v=[];P({current:60,total:100,phase:"importing"});for(let e=0;e<p.length;e+=E){const a=p.slice(e,e+E);try{var t;w+=null!==(t=(await i.A.post(`${h}/api/items/bulk`,a,G.current)).data.count)&&void 0!==t?t:a.length}catch(s){v.push(`Chunk ${e/E+1}: ${s.message}`)}P({current:60+(e+a.length)/p.length*35,total:100,phase:"importing"}),await new Promise((e=>setTimeout(e,0)))}P({current:95,total:100,phase:"finalizing"}),alert(`Imported ${w}/${p.length} rows.\n${v.length?v.join("\n"):""}`),U("/item-list")}catch(s){console.error("[bulk] import failed:",s),alert(s.message||"Bulk import error")}finally{C(!1),P({current:0,total:0,phase:"idle"})}},className:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600",children:"Import"}),(0,u.jsx)("button",{onClick:()=>U("/item-list"),className:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600",children:"Close"})]})]}),(0,u.jsxs)("div",{className:"mt-6 bg-white rounded shadow p-4",children:[(0,u.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,u.jsx)("h2",{className:"text-lg font-semibold",children:"Import Instructions"}),(0,u.jsx)("a",{href:"/templates/bulk-items-example.csv",download:!0,className:"px-4 py-2 bg-cyan-500 text-white rounded hover:bg-cyan-600",children:"Download Example Format"})]}),(0,u.jsxs)("table",{className:"w-full text-sm border border-gray-300",children:[(0,u.jsx)("thead",{className:"bg-gray-200",children:(0,u.jsxs)("tr",{children:[(0,u.jsx)("th",{className:"p-2 border",children:"#"}),(0,u.jsx)("th",{className:"p-2 border",children:"Column Name"}),(0,u.jsx)("th",{className:"p-2 border",children:"Value"}),(0,u.jsx)("th",{className:"p-2 border",children:"Description"})]})}),(0,u.jsx)("tbody",{children:[{col:1,name:"ITEM CODE",value:"Optional",desc:""},{col:2,name:"ITEM NAME",value:"Required",desc:""},{col:3,name:"CATEGORY NAME",value:"Required",desc:""},{col:4,name:"SUB CATEGORY NAME",value:"Optional",desc:""},{col:5,name:"SUB SUBCATEGORY NAME",value:"Optional",desc:""},{col:6,name:"UNIT NAME",value:"Required",desc:""},{col:7,name:"BRAND NAME",value:"Optional",desc:""},{col:8,name:"TAX NAME",value:"Required",desc:""},{col:9,name:"TAX VALUE",value:"Required",desc:""},{col:10,name:"TAX TYPE",value:"Required",desc:"'Inclusive' or 'Exclusive'"},{col:11,name:"ITEM GROUP",value:"Optional",desc:"Defaults to 'Single'"},{col:12,name:"SKU",value:"Optional",desc:""},{col:13,name:"HSN",value:"Optional",desc:""},{col:14,name:"BARCODES",value:"Optional",desc:"Comma-separated"},{col:15,name:"PRICE WITHOUT TAX",value:"Required",desc:""},{col:16,name:"PURCHASE PRICE",value:"Optional",desc:""},{col:17,name:"SALES PRICE",value:"Required",desc:""},{col:18,name:"MRP",value:"Optional",desc:""},{col:19,name:"OPENING STOCK",value:"Required",desc:""},{col:20,name:"ALERT QTY",value:"Optional",desc:""},{col:21,name:"SELLER POINTS",value:"Optional",desc:""},{col:22,name:"DISCOUNT TYPE",value:"Optional",desc:"'Percentage' or 'Flat'"},{col:23,name:"DISCOUNT",value:"Optional",desc:""},{col:24,name:"DISCOUNT POLICY",value:"Optional",desc:"'None' or 'BuyXGetY'"},{col:25,name:"REQUIRED QUANTITY",value:"Optional",desc:"Needed for BuyXGetY"},{col:26,name:"FREE QUANTITY",value:"Optional",desc:"Needed for BuyXGetY"},{col:27,name:"ITEM DESCRIPTION",value:"Optional",desc:""},{col:28,name:"EXPIRY DATE",value:"Optional",desc:"Date or Excel serial"},{col:29,name:"IMAGE CODE",value:"Optional",desc:"Used to link images; required only if OPENING STOCK > 0"},{col:30,name:"ITEM IMAGES",value:"Optional",desc:"Fallback\u2014comma-separated filenames"},{col:31,name:"VISIBILITY",value:"Optional",desc:"'Online' (default) or 'Offline'"}].map((e=>(0,u.jsxs)("tr",{className:"even:bg-gray-50",children:[(0,u.jsx)("td",{className:"p-2 border text-center",children:e.col}),(0,u.jsx)("td",{className:"p-2 border",children:e.name}),(0,u.jsx)("td",{className:"p-2 border font-semibold",children:"Required"===e.value?(0,u.jsx)("span",{className:"px-2 bg-green-100 text-green-800 rounded text-xs",children:e.value}):(0,u.jsx)("span",{className:"px-2 bg-gray-100 text-gray-600 rounded text-xs italic",children:e.value})}),(0,u.jsx)("td",{className:"p-2 border",children:e.desc})]},e.col)))})]})]})]})]})]})}}}]);
//# sourceMappingURL=7772.b100160d.chunk.js.map