"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[9622],{14840:(e,t,a)=>{a.d(t,{A:()=>l});var s=a(65043),d=a(21197),o=a(59255),i=a(70579);function l(){const[e,t]=(0,s.useState)(!1);return(0,i.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,i.jsx)(d.A,{isSidebarOpen:e,setSidebarOpen:t}),(0,i.jsxs)("div",{className:"flex flex-grow mt-20",children:[(0,i.jsx)("div",{children:(0,i.jsx)(o.A,{isSidebarOpen:e})}),(0,i.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm",children:(0,i.jsxs)("div",{className:"flex flex-col items-center",children:[(0,i.jsx)("div",{className:"w-12 h-12 border-4 rounded-full border-cyan-500 border-t-transparent animate-spin"}),(0,i.jsx)("p",{className:"mt-3 text-lg font-semibold text-gray-700",children:"Loading..."})]})})]})]})}},19622:(e,t,a)=>{a.r(t),a.d(t,{default:()=>m});var s=a(65043),d=a(66727),o=a(86213),i=a(21197),l=a(59255),n=a(14840),r=a(70579);const c=e=>{if(!e||"object"!==typeof e)return"N/A";const t=[e.street||"",e.city||"",e.state||"",e.zip||"",e.country||""].filter((e=>""!==e.trim()));return t.length>0?t.join(", "):"N/A"},m=()=>{const e=(0,d.Zp)(),t=(0,d.zy)(),a=new URLSearchParams(t.search),m=a.get("id"),x=a.get("source"),[u,p]=(0,s.useState)(!0),[h,b]=(0,s.useState)(!1),[N,y]=(0,s.useState)([]),[v,f]=(0,s.useState)({warehouse:{},customer:{},items:[],payments:[],saleDate:"",saleCode:"",amount:0,status:"",subtotal:0,tax:0,discount:0,paymentStatus:"",notes:"",creatorName:"",shippingCost:0}),[j,g]=(0,s.useState)("");(0,s.useEffect)((()=>{const e=document.createElement("script");return e.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",e.async=!0,e.onload=()=>console.log("jsPDF loaded successfully"),e.onerror=()=>console.error("Failed to load jsPDF"),document.body.appendChild(e),window.innerWidth<768&&p(!1),w(),A(),()=>{document.body.removeChild(e)}}),[]);const w=async()=>{try{const e=localStorage.getItem("token");if(!e)return;const t=await o.A.get("api/items",{headers:{Authorization:`Bearer ${e}`}}),a=(t.data.data||[]).filter((e=>{var t;return e._id&&(null===(t=e.warehouse)||void 0===t?void 0:t._id)})).map((e=>{const t=Boolean(e.parentItemId);return{...e,parentId:t?e.parentItemId:e._id,variantId:t?e._id:null,itemName:t?`${e.itemName} / ${e.variantName||"Variant"}`:e.itemName,barcode:e.barcode||"",barcodes:e.barcodes||[],itemCode:e.itemCode||""}}));y(a),console.log("Fetched allItems:",a.map((e=>{var t;return{_id:e._id,parentId:e.parentId,variantId:e.variantId,itemName:e.itemName,warehouseId:null===(t=e.warehouse)||void 0===t?void 0:t._id}})))}catch(e){console.error("Fetch items error:",e.message)}},A=async()=>{if(!m||!x)return alert("Invalid invoice ID or source"),void e("/sale-list");const t=localStorage.getItem("token");if(t){b(!0);try{const e="POS"===x?`api/pos/${m}`:`api/sales/${m}`,a=await o.A.get(e,{headers:{Authorization:`Bearer ${t}`}});if(console.log("API Response:",a.data),!a.data)throw new Error("No data returned from API");{const e=(a.data.payments||[]).reduce(((e,t)=>e+(t.amount||0)),0),t=a.data.amount||a.data.total||a.data.totalAmount||0;let s=a.data.paymentStatus||a.data.payment_state||"N/A";"N/A"===s&&(s=e>=t&&t>0?"Paid":e>0?"Partially Paid":"Unpaid");const d=(a.data.items||[]).map((e=>{var t,s,d,o,i;console.log("Processing item:",{item:e.item,variant:e.variant,itemName:e.itemName,warehouseId:(null===(t=a.data.warehouse)||void 0===t?void 0:t._id)||a.data.warehouse});const l=N.find((t=>{var s,d,o;const i=(null===(s=e.item)||void 0===s?void 0:s._id)||e.item,l=(null===(d=a.data.warehouse)||void 0===d?void 0:d._id)||a.data.warehouse;var n;return e.variant&&e.variant!==i?t.parentId===i&&(t._id===e.variant||t.variantId===e.variant)&&(null===(n=t.warehouse)||void 0===n?void 0:n._id)===l:t._id===i&&(null===(o=t.warehouse)||void 0===o?void 0:o._id)===l}));console.log("Matched itemDoc:",l?{_id:l._id,parentId:l.parentId,variantId:l.variantId,itemName:l.itemName,warehouseId:null===(s=l.warehouse)||void 0===s?void 0:s._id}:"Not found");const n=e.price||e.unitPrice||(null===l||void 0===l?void 0:l.salesPrice)||0,r=e.quantity||1,c=e.discount||0,m=(null===(d=e.tax)||void 0===d?void 0:d.taxPercentage)||(e.taxAmount?100*e.taxAmount/(n*r-c):0)||(null===l||void 0===l||null===(o=l.tax)||void 0===o?void 0:o.taxPercentage)||0,x=n*r,u=e.taxAmount||(x-c)*m/100||0,p=e.subtotal||x-c+u;return{item:(null===(i=e.item)||void 0===i?void 0:i._id)||e.item,variant:e.variant||null,itemName:e.itemName||(e.item&&"object"===typeof e.item?e.item.itemName||e.item.name||e.item.productName||e.item.title:null)||(null===l||void 0===l?void 0:l.itemName)||"N/A",itemCode:e.itemCode||(null===l||void 0===l?void 0:l.itemCode)||"",unitPrice:n,quantity:r,price:x,taxRate:m,taxAmount:u,discount:c,discountAmount:c,unitCost:(null===l||void 0===l?void 0:l.costPrice)||n,unit:e.unit||(null===l||void 0===l?void 0:l.unit)||null,total:p}}));f({warehouse:a.data.warehouse||{},customer:a.data.customer||{},items:d,payments:a.data.payments||[],saleDate:a.data.saleDate&&!isNaN(new Date(a.data.saleDate).getTime())?new Date(a.data.saleDate).toLocaleDateString():"N/A",saleCode:a.data.saleCode||"",amount:t,status:a.data.status||("POS"===x?"Completed":"N/A"),subtotal:a.data.subtotal||0,tax:a.data.tax||a.data.taxAmount||0,discount:a.data.discount||a.data.discountAmount||0,paymentStatus:s,notes:a.data.notes||a.data.comments||"",creatorName:a.data.creatorName||"N/A",shippingCost:a.data.shippingCost||0})}}catch(a){console.error("Error fetching invoice details:",a),alert(`Could not load invoice details: ${a.message}`),e("/sale-list")}finally{b(!1)}}};return h?(0,r.jsx)(n.A,{}):(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)(i.A,{isSidebarOpen:u,setSidebarOpen:p}),(0,r.jsxs)("div",{className:"box-border flex min-h-screen",children:[(0,r.jsx)("div",{className:"w-auto",children:(0,r.jsx)(l.A,{isSidebarOpen:u})}),(0,r.jsxs)("div",{className:"flex flex-col p-2 md:p-2 w-full mx-auto overflow-x-auto",children:[(0,r.jsx)("header",{className:"flex flex-col items-center justify-between px-2 py-2 mb-2 bg-gray-100 rounded-md shadow md:flex-row",children:(0,r.jsxs)("div",{className:"flex items-baseline gap-1 text-center sm:flex-row sm:text-left",children:[(0,r.jsxs)("h1",{className:"text-lg font-semibold truncate sm:text-xl",children:["View ","POS"===x?"POS Order":"Sale"]}),(0,r.jsx)("span",{className:"text-xs text-gray-600 sm:text-sm",children:"Invoice Details"})]})}),(0,r.jsxs)("div",{className:"p-4 bg-white shadow-md rounded-md mt-3 border-t-4 border-cyan-500",children:[j&&(0,r.jsx)("div",{className:"mb-4 p-2 bg-green-100 text-green-700 rounded-md",children:j}),(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Warehouse"}),(0,r.jsx)("input",{type:"text",value:v.warehouse.warehouseName||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Customer"}),(0,r.jsx)("input",{type:"text",value:v.customer.customerName||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Sale Date"}),(0,r.jsx)("input",{type:"text",value:v.saleDate||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Sale Code"}),(0,r.jsx)("input",{type:"text",value:v.saleCode||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Tax"}),(0,r.jsx)("input",{type:"text",value:`\u20b9${(v.tax||0).toFixed(2)}`,className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Discount"}),(0,r.jsx)("input",{type:"text",value:`\u20b9${(v.discount||0).toFixed(2)}`,className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Payment Status"}),(0,r.jsx)("input",{type:"text",value:v.paymentStatus||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),"POS"===x&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Status"}),(0,r.jsx)("input",{type:"text",value:v.status||"N/A",className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Shipping Address"}),(0,r.jsx)("input",{type:"text",value:c(v.customer.shippingAddress),className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Shipping Cost"}),(0,r.jsx)("input",{type:"text",value:`\u20b9${(v.shippingCost||0).toFixed(2)}`,className:"w-full p-2 border rounded-md",disabled:!0})]}),(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block font-semibold text-gray-700",children:"Notes"}),(0,r.jsx)("textarea",{value:v.notes||"N/A",className:"w-full p-2 border rounded-md",rows:"3",disabled:!0})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"Items"}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full bg-white border border-gray-300 shadow-sm",children:[(0,r.jsx)("thead",{className:"bg-gray-200",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Item"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Unit Price"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Quantity"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Price"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Tax (%)"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Tax Amount"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Discount"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Discount Amount"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Unit Cost"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Total Amount"})]})}),(0,r.jsx)("tbody",{children:0===v.items.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:"10",className:"p-4 text-center text-gray-500 border",children:"No items available"})}):v.items.map(((e,t)=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"border px-2 py-1",children:e.itemName}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.unitPrice||0).toFixed(2)]}),(0,r.jsx)("td",{className:"border px-2 py-1",children:e.quantity||0}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.price||0).toFixed(2)]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:[(e.taxRate||0).toFixed(2),"%"]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.taxAmount||0).toFixed(2)]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.discount||0).toFixed(2)]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.discountAmount||0).toFixed(2)]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.unitCost||0).toFixed(2)]}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.total||0).toFixed(2)]})]},t)))})]})})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"Payments"}),(0,r.jsxs)("table",{className:"min-w-full bg-white border border-gray-300 shadow-sm",children:[(0,r.jsx)("thead",{className:"bg-gray-200",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Payment Type"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Amount"}),(0,r.jsx)("th",{className:"px-4 py-2 text-sm font-medium text-left border",children:"Date"})]})}),(0,r.jsx)("tbody",{children:0===v.payments.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:"3",className:"p-4 text-center text-gray-500 border",children:"No payments available"})}):v.payments.map(((e,t)=>{var a;return(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"border px-2 py-1",children:(null===(a=e.paymentType)||void 0===a?void 0:a.paymentTypeName)||e.paymentTypeName||e.paymentType||"N/A"}),(0,r.jsxs)("td",{className:"border px-2 py-1",children:["\u20b9",(e.amount||0).toFixed(2)]}),(0,r.jsx)("td",{className:"border px-2 py-1",children:e.paymentDate&&!isNaN(new Date(e.paymentDate).getTime())?new Date(e.paymentDate).toLocaleDateString():"N/A"})]},t)}))})]})]}),(0,r.jsxs)("div",{className:"mt-4 flex space-x-2",children:[(0,r.jsx)("button",{onClick:()=>e("/sale-list"),className:"px-4 py-2 text-white bg-cyan-500 rounded-md hover:bg-cyan-600",children:"Back to List"}),(0,r.jsx)("button",{onClick:()=>{(()=>{const{jsPDF:e}=window.jspdf;if(!e)return console.error("jsPDF is not loaded"),g("Failed to generate PDF: jsPDF library not loaded."),void setTimeout((()=>g("")),5e3);const t=new e,a=t.internal.pageSize.getWidth();let s=15;const d=function(e,a,d,o){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;t.setFontSize(i);const l=e.split(" ");let n="";const r=[];for(let s=0;s<l.length;s++){const e=n+l[s]+" ";t.getTextWidth(e)>d&&""!==n?(r.push(n.trim()),n=l[s]+" "):n=e}return r.push(n.trim()),r.forEach(((e,d)=>{t.text(e,a,s+d*o)})),r.length*o};t.setFontSize(16),t.setFont("helvetica","bold");const o="POS"===x?"POS Order Invoice":"Sale Invoice",i=t.getTextWidth(o);t.text(o,(a-i)/2,s),s+=10,t.setFontSize(12),t.setFont("helvetica","normal");const l="Invoice Details",n=t.getTextWidth(l);t.text(l,(a-n)/2,s),s+=10,t.setFontSize(10),[`Warehouse: ${v.warehouse.warehouseName||"N/A"}`,`Customer: ${v.customer.customerName||"N/A"}`,`Sale Date: ${v.saleDate||"N/A"}`,`Sale Code: ${v.saleCode||"N/A"}`,`Tax: Rs. ${(v.tax||0).toFixed(2)}`,`Discount: Rs. ${(v.discount||0).toFixed(2)}`,`Payment Status: ${v.paymentStatus||"N/A"}`,..."POS"===x?[`Status: ${v.status||"N/A"}`]:[],`Shipping Address: ${c(v.customer.shippingAddress)}`,`Shipping Cost: Rs. ${(v.shippingCost||0).toFixed(2)}`,`Notes: ${v.notes||"N/A"}`].forEach((e=>{const[o,i]=e.split(": ");t.setFont("helvetica","bold"),t.text(o+":",15,s),t.setFont("helvetica","normal");const l=d(i,55,a-60,5,10);s+=l+3,s>270&&(t.addPage(),s=15)})),s+=10,t.setFontSize(12),t.setFont("helvetica","bold"),t.text("Items",15,s),s+=7;const r=["Item","Unit Price","Qty","Price","Tax (%)","Tax Amt","Disc","Disc Amt","Unit Cost","Total"],m=[40,18,10,18,16,16,14,16,16,16];let u=15;t.setFontSize(7),t.setFont("helvetica","bold"),r.forEach(((e,t)=>{d(e,u,m[t],4,7),u+=m[t]})),s+=5,t.line(15,s,a-15,s),s+=3,t.setFont("helvetica","normal"),0===v.items.length?(t.text("No items available",15,s),s+=6):v.items.forEach((e=>{u=15;const o=[e.itemName,`Rs. ${e.unitPrice.toFixed(2)}`,e.quantity.toString(),`Rs. ${e.price.toFixed(2)}`,`${e.taxRate.toFixed(2)}%`,`Rs. ${e.taxAmount.toFixed(2)}`,`Rs. ${e.discount.toFixed(2)}`,`Rs. ${e.discountAmount.toFixed(2)}`,`Rs. ${e.unitCost.toFixed(2)}`,`Rs. ${e.total.toFixed(2)}`];let i=0;o.forEach(((e,t)=>{const a=d(e,u,m[t],4,7);i=Math.max(i,a),u+=m[t]})),s+=i+2,s>270&&(t.addPage(),s=15,u=15,t.setFont("helvetica","bold"),r.forEach(((e,t)=>{d(e,u,m[t],4,7),u+=m[t]})),s+=5,t.line(15,s,a-15,s),s+=3,t.setFont("helvetica","normal"))})),t.line(15,s,a-15,s),s+=10,t.setFontSize(12),t.setFont("helvetica","bold"),t.text("Payments",15,s),s+=7;const p=["Payment Type","Amount","Date"],h=[80,30,40];u=15,t.setFontSize(7),t.setFont("helvetica","bold"),p.forEach(((e,t)=>{d(e,u,h[t],4,7),u+=h[t]})),s+=5,t.line(15,s,a-15,s),s+=3,t.setFont("helvetica","normal"),0===v.payments.length?(t.text("No payments available",15,s),s+=6):v.payments.forEach((e=>{var o;u=15;const i=["string"===typeof e.paymentType?e.paymentType.match(/^[0-9a-fA-F]{24}$/)?"Cash":e.paymentType:(null===(o=e.paymentType)||void 0===o?void 0:o.paymentTypeName)||"Cash",`Rs. ${e.amount.toFixed(2)}`,e.paymentDate&&!isNaN(new Date(e.paymentDate).getTime())?new Date(e.paymentDate).toLocaleDateString():"N/A"];let l=0;i.forEach(((e,t)=>{const a=d(e,u,h[t],4,7);l=Math.max(l,a),u+=h[t]})),s+=l+2,s>270&&(t.addPage(),s=15,u=15,t.setFont("helvetica","bold"),p.forEach(((e,t)=>{d(e,u,h[t],4,7),u+=h[t]})),s+=5,t.line(15,s,a-15,s),s+=3,t.setFont("helvetica","normal"))})),t.line(15,s,a-15,s);const b=t.output("blob"),N=URL.createObjectURL(b),y=document.createElement("a");y.href=N,y.download=`Invoice-${v.saleCode||"unknown"}.pdf`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(N),g("PDF has been downloaded successfully."),setTimeout((()=>g("")),5e3)})()},className:"px-4 py-2 text-white bg-green-500 rounded-md hover:bg-green-600",children:"Download PDF"})]})]})]})]})]})}}}]);
//# sourceMappingURL=9622.b921c7c2.chunk.js.map