"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[5283],{65283:(e,t,a)=>{a.r(t),a.d(t,{default:()=>d});var s=a(65043),r=a(86213),n=a(75200),l=a(21197),i=a(59255),o=a(70579);const c=r.A.create({baseURL:"/vps/api"});function d(){var e;const t=localStorage.getItem("userId"),[a,r]=(0,s.useState)(!0),[d,u]=(0,s.useState)([]),[m,x]=(0,s.useState)(null),[h,g]=(0,s.useState)([]),[f,v]=(0,s.useState)(""),p=(0,s.useRef)(null),[b,y]=(0,s.useState)(""),[w,j]=(0,s.useState)([]),N=(0,s.useRef)(null),S=(0,s.useRef)(null),k=async()=>{const{data:e}=await c.get("/chat/conversations");u(await(async e=>Promise.all(e.map((async e=>{try{const a=(await c.get(`/chat/conversations/${e._id}/messages?limit=1`)).data.data[0];return{...e,unread:a&&!a.readBy.includes(t)&&a.sender!==t}}catch{return{...e,unread:!1}}}))))(e.data))},C=async e=>{const{data:t}=await c.get(`/chat/conversations/${e}/messages?limit=100`);g(t.data),await c.patch(`/chat/conversations/${e}/readAll`),k(),setTimeout((()=>{var e;return null===(e=p.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})}),0)},I=e=>{x(e),C(e),clearInterval(S.current),S.current=setInterval((()=>C(e)),5e3)},_=async()=>{if(!f.trim()||!m)return;const e={_id:"tmp-"+Date.now(),sender:t,body:f,createdAt:(new Date).toISOString()};g((t=>[...t,e])),v(""),setTimeout((()=>{var e;return null===(e=p.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})}),0);try{await c.post("/chat/messages",{conversationId:m,body:e.body}),C(m)}catch{g((t=>t.filter((t=>t._id!==e._id)))),alert("Failed")}},A=(0,s.useCallback)((async e=>{if(e.length<2)j([]);else try{const{data:t}=await c.get(`/customers?search=${encodeURIComponent(e)}`);j(t.data)}catch{j([])}}),[]);(0,s.useEffect)((()=>{A(b)}),[b,A]);return(0,s.useEffect)((()=>(k(),N.current=setInterval(k,5e3),()=>{clearInterval(N.current),clearInterval(S.current)})),[]),(0,o.jsxs)("div",{className:"flex flex-col h-screen bg-gray-50",children:[(0,o.jsx)(l.A,{isSidebarOpen:a,setSidebarOpen:r}),(0,o.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,o.jsx)(i.A,{isSidebarOpen:a}),(0,o.jsxs)("aside",{className:"w-60 border-r bg-white shadow-sm flex flex-col overflow-y-auto relative",children:[(0,o.jsx)("div",{className:"p-4 border-b bg-gray-50",children:(0,o.jsxs)("div",{className:"relative",children:[(0,o.jsx)("input",{value:b,onChange:e=>y(e.target.value),placeholder:"Search customer\u2026",className:"w-full p-2 pl-8 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-300 transition"}),(0,o.jsx)("svg",{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"})}),!!w.length&&(0,o.jsx)("ul",{className:"absolute z-10 bg-white border rounded-lg w-full mt-1 max-h-48 overflow-y-auto shadow-lg transition-all duration-200",children:w.map((e=>(0,o.jsx)("li",{onClick:()=>(async e=>{y(""),j([]);try{const{data:t}=await c.post("/chat/conversations",{otherUserId:e._id});await k(),I(t.data._id)}catch{alert("Could not start chat")}})(e),className:"px-3 py-2 text-sm hover:bg-blue-50 cursor-pointer transition-colors",children:e.name},e._id)))})]})}),d.map((e=>{var a;const s=e.participants.find((e=>e!==t))||"Unknown";return(0,o.jsxs)("div",{onClick:()=>I(e._id),className:"relative px-4 py-3 text-sm cursor-pointer hover:bg-blue-50 transition-colors "+(m===e._id?"bg-blue-100":""),children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("div",{className:"h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600",children:null===(a=s[0])||void 0===a?void 0:a.toUpperCase()}),(0,o.jsx)("span",{className:"truncate",children:s})]}),e.unread&&(0,o.jsx)("span",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 h-2.5 w-2.5 bg-red-500 rounded-full shadow"})]},e._id)}))]}),(0,o.jsx)("section",{className:"flex-1 flex flex-col bg-gradient-to-b from-gray-50 to-gray-100",children:m?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"p-4 border-b bg-white shadow-sm",children:(0,o.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:(null===(e=d.find((e=>e._id===m)))||void 0===e?void 0:e.participants.find((e=>e!==t)))||"Chat"})}),(0,o.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[h.map((e=>{var a;const s=e.sender===t;return(0,o.jsx)("div",{className:`flex ${s?"justify-end":"justify-start"} mb-2 animate-fade-in`,children:(0,o.jsxs)("div",{className:"flex items-end gap-2 "+(s?"flex-row-reverse":""),children:[(0,o.jsx)("div",{className:"h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center text-xs text-gray-600",children:s?"You":null===(a=e.sender[0])||void 0===a?void 0:a.toUpperCase()}),(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"max-w-xs px-4 py-2 rounded-2xl text-sm shadow-sm "+(s?"bg-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"),children:e.body}),(0,o.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:[new Date(e.createdAt).toLocaleTimeString(),s&&e._id.startsWith("tmp-")&&(0,o.jsx)("span",{className:"ml-1 text-gray-400",children:"Sending..."})]})]})]})},e._id)})),(0,o.jsx)("div",{ref:p})]}),(0,o.jsx)("div",{className:"p-4 bg-white border-t shadow-sm",children:(0,o.jsxs)("div",{className:"flex items-center gap-2 max-w-3xl mx-auto",children:[(0,o.jsx)("input",{className:"flex-1 p-2.5 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-300 transition",placeholder:"Type a message...",value:f,onChange:e=>v(e.target.value),onKeyDown:e=>"Enter"===e.key&&_(),"aria-label":"Type a message"}),(0,o.jsx)("button",{onClick:_,className:"p-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105","aria-label":"Send message",children:(0,o.jsx)(n.kGk,{size:18})})]})})]}):(0,o.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500 text-lg",children:"Select or start a conversation"})})]})]})}c.interceptors.request.use((e=>{const t=localStorage.getItem("token");return t&&(e.headers.Authorization=`Bearer ${t}`),e}))}}]);
//# sourceMappingURL=5283.1a411b12.chunk.js.map